void vp9_encode_frame ( VP9_COMP * cpi ) { //<S2SV> VP9_COMMON * const cm = & cpi -> common ; //<S2SV> if ( ! frame_is_intra_only ( cm ) ) { //<S2SV> if ( ( cm -> ref_frame_sign_bias [ ALTREF_FRAME ] == //<S2SV> cm -> ref_frame_sign_bias [ GOLDEN_FRAME ] ) || //<S2SV> ( cm -> ref_frame_sign_bias [ ALTREF_FRAME ] == //<S2SV> cm -> ref_frame_sign_bias [ LAST_FRAME ] ) ) { //<S2SV> cpi -> allow_comp_inter_inter = 0 ; //<S2SV> } else { //<S2SV> cpi -> allow_comp_inter_inter = 1 ; //<S2SV> cm -> comp_fixed_ref = ALTREF_FRAME ; //<S2SV> cm -> comp_var_ref [ 0 ] = LAST_FRAME ; //<S2SV> cm -> comp_var_ref [ 1 ] = GOLDEN_FRAME ; //<S2SV> } //<S2SV> } //<S2SV> if ( cpi -> sf . frame_parameter_update ) { //<S2SV> int i ; //<S2SV> RD_OPT * const rd_opt = & cpi -> rd ; //<S2SV> FRAME_COUNTS * counts = cpi -> td . counts ; //<S2SV> RD_COUNTS * const rdc = & cpi -> td . rd_counts ; //<S2SV> const MV_REFERENCE_FRAME frame_type = get_frame_type ( cpi ) ; //<S2SV> int64_t * const mode_thrs = rd_opt -> prediction_type_threshes [ frame_type ] ; //<S2SV> int64_t * const filter_thrs = rd_opt -> filter_threshes [ frame_type ] ; //<S2SV> const int is_alt_ref = frame_type == ALTREF_FRAME ; //<S2SV> if ( is_alt_ref || ! cpi -> allow_comp_inter_inter ) //<S2SV> cm -> reference_mode = SINGLE_REFERENCE ; //<S2SV> else if ( mode_thrs [ COMPOUND_REFERENCE ] > mode_thrs [ SINGLE_REFERENCE ] && //<S2SV> mode_thrs [ COMPOUND_REFERENCE ] > //<S2SV> mode_thrs [ REFERENCE_MODE_SELECT ] && //<S2SV> check_dual_ref_flags ( cpi ) && //<S2SV> cpi -> static_mb_pct == 100 ) //<S2SV> cm -> reference_mode = COMPOUND_REFERENCE ; //<S2SV> else if ( mode_thrs [ SINGLE_REFERENCE ] > mode_thrs [ REFERENCE_MODE_SELECT ] ) //<S2SV> cm -> reference_mode = SINGLE_REFERENCE ; //<S2SV> else //<S2SV> cm -> reference_mode = REFERENCE_MODE_SELECT ; //<S2SV> if ( cm -> interp_filter == SWITCHABLE ) //<S2SV> cm -> interp_filter = get_interp_filter ( filter_thrs , is_alt_ref ) ; //<S2SV> encode_frame_internal ( cpi ) ; //<S2SV> for ( i = 0 ; i < REFERENCE_MODES ; ++ i ) //<S2SV> mode_thrs [ i ] = ( mode_thrs [ i ] + rdc -> comp_pred_diff [ i ] / cm -> MBs ) / 2 ; //<S2SV> for ( i = 0 ; i < SWITCHABLE_FILTER_CONTEXTS ; ++ i ) //<S2SV> filter_thrs [ i ] = ( filter_thrs [ i ] + rdc -> filter_diff [ i ] / cm -> MBs ) / 2 ; //<S2SV> if ( cm -> reference_mode == REFERENCE_MODE_SELECT ) { //<S2SV> int single_count_zero = 0 ; //<S2SV> int comp_count_zero = 0 ; //<S2SV> for ( i = 0 ; i < COMP_INTER_CONTEXTS ; i ++ ) { //<S2SV> single_count_zero += counts -> comp_inter [ i ] [ 0 ] ; //<S2SV> comp_count_zero += counts -> comp_inter [ i ] [ 1 ] ; //<S2SV> } //<S2SV> if ( comp_count_zero == 0 ) { //<S2SV> cm -> reference_mode = SINGLE_REFERENCE ; //<S2SV> vp9_zero ( counts -> comp_inter ) ; //<S2SV> } else if ( single_count_zero == 0 ) { //<S2SV> cm -> reference_mode = COMPOUND_REFERENCE ; //<S2SV> vp9_zero ( counts -> comp_inter ) ; //<S2SV> } //<S2SV> } //<S2SV> if ( cm -> tx_mode == TX_MODE_SELECT ) { //<S2SV> int count4x4 = 0 ; //<S2SV> int count8x8_lp = 0 , count8x8_8x8p = 0 ; //<S2SV> int count16x16_16x16p = 0 , count16x16_lp = 0 ; //<S2SV> int count32x32 = 0 ; //<S2SV> for ( i = 0 ; i < TX_SIZE_CONTEXTS ; ++ i ) { //<S2SV> count4x4 += counts -> tx . p32x32 [ i ] [ TX_4X4 ] ; //<S2SV> count4x4 += counts -> tx . p16x16 [ i ] [ TX_4X4 ] ; //<S2SV> count4x4 += counts -> tx . p8x8 [ i ] [ TX_4X4 ] ; //<S2SV> count8x8_lp += counts -> tx . p32x32 [ i ] [ TX_8X8 ] ; //<S2SV> count8x8_lp += counts -> tx . p16x16 [ i ] [ TX_8X8 ] ; //<S2SV> count8x8_8x8p += counts -> tx . p8x8 [ i ] [ TX_8X8 ] ; //<S2SV> count16x16_16x16p += counts -> tx . p16x16 [ i ] [ TX_16X16 ] ; //<S2SV> count16x16_lp += counts -> tx . p32x32 [ i ] [ TX_16X16 ] ; //<S2SV> count32x32 += counts -> tx . p32x32 [ i ] [ TX_32X32 ] ; //<S2SV> } //<S2SV> if ( count4x4 == 0 && count16x16_lp == 0 && count16x16_16x16p == 0 && //<S2SV> count32x32 == 0 ) { //<S2SV> cm -> tx_mode = ALLOW_8X8 ; //<S2SV> reset_skip_tx_size ( cm , TX_8X8 ) ; //<S2SV> } else if ( count8x8_8x8p == 0 && count16x16_16x16p == 0 && //<S2SV> count8x8_lp == 0 && count16x16_lp == 0 && count32x32 == 0 ) { //<S2SV> cm -> tx_mode = ONLY_4X4 ; //<S2SV> reset_skip_tx_size ( cm , TX_4X4 ) ; //<S2SV> } else if ( count8x8_lp == 0 && count16x16_lp == 0 && count4x4 == 0 ) { //<S2SV> cm -> tx_mode = ALLOW_32X32 ; //<S2SV> } else if ( count32x32 == 0 && count8x8_lp == 0 && count4x4 == 0 ) { //<S2SV> cm -> tx_mode = ALLOW_16X16 ; //<S2SV> reset_skip_tx_size ( cm , TX_16X16 ) ; //<S2SV> } //<S2SV> } //<S2SV> } else { //<S2SV> cm -> reference_mode = SINGLE_REFERENCE ; //<S2SV> encode_frame_internal ( cpi ) ; //<S2SV> } //<S2SV> } //<S2SV> 