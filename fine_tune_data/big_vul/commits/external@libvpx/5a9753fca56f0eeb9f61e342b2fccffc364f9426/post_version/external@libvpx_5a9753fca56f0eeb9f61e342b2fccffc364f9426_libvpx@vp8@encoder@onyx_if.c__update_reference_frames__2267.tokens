static void update_reference_frames ( VP8_COMP * cpi ) //<S2SV> { //<S2SV> VP8_COMMON * cm = & cpi -> common ; //<S2SV> YV12_BUFFER_CONFIG * yv12_fb = cm -> yv12_fb ; //<S2SV> if ( cm -> frame_type == KEY_FRAME ) //<S2SV> { //<S2SV> yv12_fb [ cm -> new_fb_idx ] . flags |= VP8_GOLD_FRAME | VP8_ALTR_FRAME ; //<S2SV> yv12_fb [ cm -> gld_fb_idx ] . flags &= ~ VP8_GOLD_FRAME ; //<S2SV> yv12_fb [ cm -> alt_fb_idx ] . flags &= ~ VP8_ALTR_FRAME ; //<S2SV> cm -> alt_fb_idx = cm -> gld_fb_idx = cm -> new_fb_idx ; //<S2SV> cpi -> current_ref_frames [ GOLDEN_FRAME ] = cm -> current_video_frame ; //<S2SV> cpi -> current_ref_frames [ ALTREF_FRAME ] = cm -> current_video_frame ; //<S2SV> } //<S2SV> else //<S2SV> { //<S2SV> if ( cm -> refresh_alt_ref_frame ) //<S2SV> { //<S2SV> assert ( ! cm -> copy_buffer_to_arf ) ; //<S2SV> cm -> yv12_fb [ cm -> new_fb_idx ] . flags |= VP8_ALTR_FRAME ; //<S2SV> cm -> yv12_fb [ cm -> alt_fb_idx ] . flags &= ~ VP8_ALTR_FRAME ; //<S2SV> cm -> alt_fb_idx = cm -> new_fb_idx ; //<S2SV> cpi -> current_ref_frames [ ALTREF_FRAME ] = cm -> current_video_frame ; //<S2SV> } //<S2SV> else if ( cm -> copy_buffer_to_arf ) //<S2SV> { //<S2SV> assert ( ! ( cm -> copy_buffer_to_arf & ~ 0x3 ) ) ; //<S2SV> if ( cm -> copy_buffer_to_arf == 1 ) //<S2SV> { //<S2SV> if ( cm -> alt_fb_idx != cm -> lst_fb_idx ) //<S2SV> { //<S2SV> yv12_fb [ cm -> lst_fb_idx ] . flags |= VP8_ALTR_FRAME ; //<S2SV> yv12_fb [ cm -> alt_fb_idx ] . flags &= ~ VP8_ALTR_FRAME ; //<S2SV> cm -> alt_fb_idx = cm -> lst_fb_idx ; //<S2SV> cpi -> current_ref_frames [ ALTREF_FRAME ] = //<S2SV> cpi -> current_ref_frames [ LAST_FRAME ] ; //<S2SV> } //<S2SV> } //<S2SV> else //<S2SV> { //<S2SV> if ( cm -> alt_fb_idx != cm -> gld_fb_idx ) //<S2SV> { //<S2SV> yv12_fb [ cm -> gld_fb_idx ] . flags |= VP8_ALTR_FRAME ; //<S2SV> yv12_fb [ cm -> alt_fb_idx ] . flags &= ~ VP8_ALTR_FRAME ; //<S2SV> cm -> alt_fb_idx = cm -> gld_fb_idx ; //<S2SV> cpi -> current_ref_frames [ ALTREF_FRAME ] = //<S2SV> cpi -> current_ref_frames [ GOLDEN_FRAME ] ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> if ( cm -> refresh_golden_frame ) //<S2SV> { //<S2SV> assert ( ! cm -> copy_buffer_to_gf ) ; //<S2SV> cm -> yv12_fb [ cm -> new_fb_idx ] . flags |= VP8_GOLD_FRAME ; //<S2SV> cm -> yv12_fb [ cm -> gld_fb_idx ] . flags &= ~ VP8_GOLD_FRAME ; //<S2SV> cm -> gld_fb_idx = cm -> new_fb_idx ; //<S2SV> cpi -> current_ref_frames [ GOLDEN_FRAME ] = cm -> current_video_frame ; //<S2SV> } //<S2SV> else if ( cm -> copy_buffer_to_gf ) //<S2SV> { //<S2SV> assert ( ! ( cm -> copy_buffer_to_arf & ~ 0x3 ) ) ; //<S2SV> if ( cm -> copy_buffer_to_gf == 1 ) //<S2SV> { //<S2SV> if ( cm -> gld_fb_idx != cm -> lst_fb_idx ) //<S2SV> { //<S2SV> yv12_fb [ cm -> lst_fb_idx ] . flags |= VP8_GOLD_FRAME ; //<S2SV> yv12_fb [ cm -> gld_fb_idx ] . flags &= ~ VP8_GOLD_FRAME ; //<S2SV> cm -> gld_fb_idx = cm -> lst_fb_idx ; //<S2SV> cpi -> current_ref_frames [ GOLDEN_FRAME ] = //<S2SV> cpi -> current_ref_frames [ LAST_FRAME ] ; //<S2SV> } //<S2SV> } //<S2SV> else //<S2SV> { //<S2SV> if ( cm -> alt_fb_idx != cm -> gld_fb_idx ) //<S2SV> { //<S2SV> yv12_fb [ cm -> alt_fb_idx ] . flags |= VP8_GOLD_FRAME ; //<S2SV> yv12_fb [ cm -> gld_fb_idx ] . flags &= ~ VP8_GOLD_FRAME ; //<S2SV> cm -> gld_fb_idx = cm -> alt_fb_idx ; //<S2SV> cpi -> current_ref_frames [ GOLDEN_FRAME ] = //<S2SV> cpi -> current_ref_frames [ ALTREF_FRAME ] ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> if ( cm -> refresh_last_frame ) //<S2SV> { //<S2SV> cm -> yv12_fb [ cm -> new_fb_idx ] . flags |= VP8_LAST_FRAME ; //<S2SV> cm -> yv12_fb [ cm -> lst_fb_idx ] . flags &= ~ VP8_LAST_FRAME ; //<S2SV> cm -> lst_fb_idx = cm -> new_fb_idx ; //<S2SV> cpi -> current_ref_frames [ LAST_FRAME ] = cm -> current_video_frame ; //<S2SV> } //<S2SV> # if CONFIG_TEMPORAL_DENOISING //<S2SV> if ( cpi -> oxcf . noise_sensitivity ) //<S2SV> { //<S2SV> if ( cm -> frame_type == KEY_FRAME ) //<S2SV> { //<S2SV> int i ; //<S2SV> for ( i = LAST_FRAME ; i < MAX_REF_FRAMES ; ++ i ) //<S2SV> vp8_yv12_copy_frame ( cpi -> Source , //<S2SV> & cpi -> denoiser . yv12_running_avg [ i ] ) ; //<S2SV> } //<S2SV> else //<S2SV> { //<S2SV> vp8_yv12_extend_frame_borders ( //<S2SV> & cpi -> denoiser . yv12_running_avg [ INTRA_FRAME ] ) ; //<S2SV> if ( cm -> refresh_alt_ref_frame || cm -> copy_buffer_to_arf ) //<S2SV> { //<S2SV> vp8_yv12_copy_frame ( //<S2SV> & cpi -> denoiser . yv12_running_avg [ INTRA_FRAME ] , //<S2SV> & cpi -> denoiser . yv12_running_avg [ ALTREF_FRAME ] ) ; //<S2SV> } //<S2SV> if ( cm -> refresh_golden_frame || cm -> copy_buffer_to_gf ) //<S2SV> { //<S2SV> vp8_yv12_copy_frame ( //<S2SV> & cpi -> denoiser . yv12_running_avg [ INTRA_FRAME ] , //<S2SV> & cpi -> denoiser . yv12_running_avg [ GOLDEN_FRAME ] ) ; //<S2SV> } //<S2SV> if ( cm -> refresh_last_frame ) //<S2SV> { //<S2SV> vp8_yv12_copy_frame ( //<S2SV> & cpi -> denoiser . yv12_running_avg [ INTRA_FRAME ] , //<S2SV> & cpi -> denoiser . yv12_running_avg [ LAST_FRAME ] ) ; //<S2SV> } //<S2SV> } //<S2SV> if ( cpi -> oxcf . noise_sensitivity == 4 ) //<S2SV> vp8_yv12_copy_frame ( cpi -> Source , & cpi -> denoiser . yv12_last_source ) ; //<S2SV> } //<S2SV> # endif //<S2SV> } //<S2SV> 