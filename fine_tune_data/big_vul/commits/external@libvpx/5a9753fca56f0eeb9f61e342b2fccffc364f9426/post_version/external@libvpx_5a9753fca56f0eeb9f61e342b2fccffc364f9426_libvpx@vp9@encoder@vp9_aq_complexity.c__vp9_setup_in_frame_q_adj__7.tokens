void vp9_setup_in_frame_q_adj ( VP9_COMP * cpi ) { //<S2SV> VP9_COMMON * const cm = & cpi -> common ; //<S2SV> struct segmentation * const seg = & cm -> seg ; //<S2SV> vpx_clear_system_state ( ) ; //<S2SV> if ( cm -> frame_type == KEY_FRAME || //<S2SV> cpi -> refresh_alt_ref_frame || //<S2SV> ( cpi -> refresh_golden_frame && ! cpi -> rc . is_src_frame_alt_ref ) ) { //<S2SV> int segment ; //<S2SV> const int aq_strength = get_aq_c_strength ( cm -> base_qindex , cm -> bit_depth ) ; //<S2SV> memset ( cpi -> segmentation_map , DEFAULT_AQ2_SEG , cm -> mi_rows * cm -> mi_cols ) ; //<S2SV> vp9_clearall_segfeatures ( seg ) ; //<S2SV> if ( cpi -> rc . sb64_target_rate < 256 ) { //<S2SV> vp9_disable_segmentation ( seg ) ; //<S2SV> return ; //<S2SV> } //<S2SV> vp9_enable_segmentation ( seg ) ; //<S2SV> seg -> abs_delta = SEGMENT_DELTADATA ; //<S2SV> vp9_disable_segfeature ( seg , DEFAULT_AQ2_SEG , SEG_LVL_ALT_Q ) ; //<S2SV> for ( segment = 0 ; segment < AQ_C_SEGMENTS ; ++ segment ) { //<S2SV> int qindex_delta ; //<S2SV> if ( segment == DEFAULT_AQ2_SEG ) //<S2SV> continue ; //<S2SV> qindex_delta = //<S2SV> vp9_compute_qdelta_by_rate ( & cpi -> rc , cm -> frame_type , cm -> base_qindex , //<S2SV> aq_c_q_adj_factor [ aq_strength ] [ segment ] , //<S2SV> cm -> bit_depth ) ; //<S2SV> if ( ( cm -> base_qindex != 0 ) && ( ( cm -> base_qindex + qindex_delta ) == 0 ) ) { //<S2SV> qindex_delta = - cm -> base_qindex + 1 ; //<S2SV> } //<S2SV> if ( ( cm -> base_qindex + qindex_delta ) > 0 ) { //<S2SV> vp9_enable_segfeature ( seg , segment , SEG_LVL_ALT_Q ) ; //<S2SV> vp9_set_segdata ( seg , segment , SEG_LVL_ALT_Q , qindex_delta ) ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> 