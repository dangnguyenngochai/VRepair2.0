static int calc_active_worst_quality_one_pass_cbr ( const VP9_COMP * cpi ) { //<S2SV> const VP9_COMMON * const cm = & cpi -> common ; //<S2SV> const VP9_CONFIG * oxcf = & cpi -> oxcf ; //<S2SV> const RATE_CONTROL * rc = & cpi -> rc ; //<S2SV> int64_t critical_level = oxcf -> optimal_buffer_level >> 2 ; //<S2SV> int64_t buff_lvl_step = 0 ; //<S2SV> int adjustment = 0 ; //<S2SV> int active_worst_quality ; //<S2SV> if ( cm -> frame_type == KEY_FRAME ) //<S2SV> return rc -> worst_quality ; //<S2SV> if ( cm -> current_video_frame > 1 ) //<S2SV> active_worst_quality = MIN ( rc -> worst_quality , //<S2SV> rc -> avg_frame_qindex [ INTER_FRAME ] * 5 / 4 ) ; //<S2SV> else //<S2SV> active_worst_quality = MIN ( rc -> worst_quality , //<S2SV> rc -> avg_frame_qindex [ KEY_FRAME ] * 3 / 2 ) ; //<S2SV> if ( rc -> buffer_level > oxcf -> optimal_buffer_level ) { //<S2SV> int max_adjustment_down = active_worst_quality / 3 ; //<S2SV> if ( max_adjustment_down ) { //<S2SV> buff_lvl_step = ( ( oxcf -> maximum_buffer_size - //<S2SV> oxcf -> optimal_buffer_level ) / max_adjustment_down ) ; //<S2SV> if ( buff_lvl_step ) //<S2SV> adjustment = ( int ) ( ( rc -> buffer_level - oxcf -> optimal_buffer_level ) / //<S2SV> buff_lvl_step ) ; //<S2SV> active_worst_quality -= adjustment ; //<S2SV> } //<S2SV> } else if ( rc -> buffer_level > critical_level ) { //<S2SV> if ( critical_level ) { //<S2SV> buff_lvl_step = ( oxcf -> optimal_buffer_level - critical_level ) ; //<S2SV> if ( buff_lvl_step ) { //<S2SV> adjustment = //<S2SV> ( int ) ( ( rc -> worst_quality - rc -> avg_frame_qindex [ INTER_FRAME ] ) * //<S2SV> ( oxcf -> optimal_buffer_level - rc -> buffer_level ) / //<S2SV> buff_lvl_step ) ; //<S2SV> } //<S2SV> active_worst_quality = rc -> avg_frame_qindex [ INTER_FRAME ] + adjustment ; //<S2SV> } //<S2SV> } else { //<S2SV> active_worst_quality = rc -> worst_quality ; //<S2SV> } //<S2SV> return active_worst_quality ; //<S2SV> } //<S2SV> 