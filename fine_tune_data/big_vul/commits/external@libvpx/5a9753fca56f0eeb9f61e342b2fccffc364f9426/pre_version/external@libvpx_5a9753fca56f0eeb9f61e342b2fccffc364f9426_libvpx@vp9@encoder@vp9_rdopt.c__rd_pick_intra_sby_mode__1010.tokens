static int64_t rd_pick_intra_sby_mode ( VP9_COMP * cpi , MACROBLOCK * x , //<S2SV> int * rate , int * rate_tokenonly , //<S2SV> int64_t * distortion , int * skippable , //<S2SV> BLOCK_SIZE bsize , //<S2SV> int64_t tx_cache [ TX_MODES ] , //<S2SV> int64_t best_rd ) { //<S2SV> MB_PREDICTION_MODE mode ; //<S2SV> MB_PREDICTION_MODE mode_selected = DC_PRED ; //<S2SV> MACROBLOCKD * const xd = & x -> e_mbd ; //<S2SV> MODE_INFO * const mic = xd -> mi [ 0 ] ; //<S2SV> int this_rate , this_rate_tokenonly , s ; //<S2SV> int64_t this_distortion , this_rd ; //<S2SV> TX_SIZE best_tx = TX_4X4 ; //<S2SV> int i ; //<S2SV> int * bmode_costs = x -> mbmode_cost ; //<S2SV> if ( cpi -> sf . tx_size_search_method == USE_FULL_RD ) //<S2SV> for ( i = 0 ; i < TX_MODES ; i ++ ) //<S2SV> tx_cache [ i ] = INT64_MAX ; //<S2SV> for ( mode = DC_PRED ; mode <= TM_PRED ; mode ++ ) { //<S2SV> int64_t local_tx_cache [ TX_MODES ] ; //<S2SV> MODE_INFO * above_mi = xd -> mi [ - xd -> mi_stride ] ; //<S2SV> MODE_INFO * left_mi = xd -> left_available ? xd -> mi [ - 1 ] : NULL ; //<S2SV> if ( ! ( cpi -> sf . intra_y_mode_mask [ max_txsize_lookup [ bsize ] ] & ( 1 << mode ) ) ) //<S2SV> continue ; //<S2SV> if ( cpi -> common . frame_type == KEY_FRAME ) { //<S2SV> const MB_PREDICTION_MODE A = vp9_above_block_mode ( mic , above_mi , 0 ) ; //<S2SV> const MB_PREDICTION_MODE L = vp9_left_block_mode ( mic , left_mi , 0 ) ; //<S2SV> bmode_costs = x -> y_mode_costs [ A ] [ L ] ; //<S2SV> } //<S2SV> mic -> mbmi . mode = mode ; //<S2SV> intra_super_block_yrd ( cpi , x , & this_rate_tokenonly , & this_distortion , //<S2SV> & s , NULL , bsize , local_tx_cache , best_rd ) ; //<S2SV> if ( this_rate_tokenonly == INT_MAX ) //<S2SV> continue ; //<S2SV> this_rate = this_rate_tokenonly + bmode_costs [ mode ] ; //<S2SV> this_rd = RDCOST ( x -> rdmult , x -> rddiv , this_rate , this_distortion ) ; //<S2SV> if ( this_rd < best_rd ) { //<S2SV> mode_selected = mode ; //<S2SV> best_rd = this_rd ; //<S2SV> best_tx = mic -> mbmi . tx_size ; //<S2SV> * rate = this_rate ; //<S2SV> * rate_tokenonly = this_rate_tokenonly ; //<S2SV> * distortion = this_distortion ; //<S2SV> * skippable = s ; //<S2SV> } //<S2SV> if ( cpi -> sf . tx_size_search_method == USE_FULL_RD && this_rd < INT64_MAX ) { //<S2SV> for ( i = 0 ; i < TX_MODES && local_tx_cache [ i ] < INT64_MAX ; i ++ ) { //<S2SV> const int64_t adj_rd = this_rd + local_tx_cache [ i ] - //<S2SV> local_tx_cache [ cpi -> common . tx_mode ] ; //<S2SV> if ( adj_rd < tx_cache [ i ] ) { //<S2SV> tx_cache [ i ] = adj_rd ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> mic -> mbmi . mode = mode_selected ; //<S2SV> mic -> mbmi . tx_size = best_tx ; //<S2SV> return best_rd ; //<S2SV> } //<S2SV> 