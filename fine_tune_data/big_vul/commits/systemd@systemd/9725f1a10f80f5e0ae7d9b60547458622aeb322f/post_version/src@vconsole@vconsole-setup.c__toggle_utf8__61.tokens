static int toggle_utf8 ( const char * name , int fd , bool utf8 ) { //<S2SV> int r ; //<S2SV> struct termios tc = { } ; //<S2SV> assert ( name ) ; //<S2SV> r = vt_verify_kbmode ( fd ) ; //<S2SV> if ( r == - EBUSY ) { //<S2SV> log_warning_errno ( r , "Virtual<S2SV_blank>console<S2SV_blank>%s<S2SV_blank>is<S2SV_blank>not<S2SV_blank>in<S2SV_blank>K_XLATE<S2SV_blank>or<S2SV_blank>K_UNICODE:<S2SV_blank>%m" , name ) ; //<S2SV> return 0 ; //<S2SV> } else if ( r < 0 ) //<S2SV> return log_warning_errno ( r , "Failed<S2SV_blank>to<S2SV_blank>verify<S2SV_blank>kbdmode<S2SV_blank>on<S2SV_blank>%s:<S2SV_blank>%m" , name ) ; //<S2SV> r = ioctl ( fd , KDSKBMODE , utf8 ? K_UNICODE : K_XLATE ) ; //<S2SV> if ( r < 0 ) //<S2SV> return log_warning_errno ( errno , "Failed<S2SV_blank>to<S2SV_blank>%s<S2SV_blank>UTF-8<S2SV_blank>kbdmode<S2SV_blank>on<S2SV_blank>%s:<S2SV_blank>%m" , enable_disable ( utf8 ) , name ) ; //<S2SV> r = loop_write ( fd , utf8 ? "\\033%G" : "\\033%@" , 3 , false ) ; //<S2SV> if ( r < 0 ) //<S2SV> return log_warning_errno ( r , "Failed<S2SV_blank>to<S2SV_blank>%s<S2SV_blank>UTF-8<S2SV_blank>term<S2SV_blank>processing<S2SV_blank>on<S2SV_blank>%s:<S2SV_blank>%m" , enable_disable ( utf8 ) , name ) ; //<S2SV> r = tcgetattr ( fd , & tc ) ; //<S2SV> if ( r >= 0 ) { //<S2SV> SET_FLAG ( tc . c_iflag , IUTF8 , utf8 ) ; //<S2SV> r = tcsetattr ( fd , TCSANOW , & tc ) ; //<S2SV> } //<S2SV> if ( r < 0 ) //<S2SV> return log_warning_errno ( errno , "Failed<S2SV_blank>to<S2SV_blank>%s<S2SV_blank>iutf8<S2SV_blank>flag<S2SV_blank>on<S2SV_blank>%s:<S2SV_blank>%m" , enable_disable ( utf8 ) , name ) ; //<S2SV> log_debug ( "UTF-8<S2SV_blank>kbdmode<S2SV_blank>%sd<S2SV_blank>on<S2SV_blank>%s" , enable_disable ( utf8 ) , name ) ; //<S2SV> return 0 ; //<S2SV> } //<S2SV> 