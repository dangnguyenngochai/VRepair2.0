enum ImapAuthRes imap_auth_cram_md5 ( struct ImapData * idata , const char * method ) //<S2SV> { //<S2SV> char ibuf [ LONG_STRING * 2 ] , obuf [ LONG_STRING ] ; //<S2SV> unsigned char hmac_response [ MD5_DIGEST_LEN ] ; //<S2SV> int len ; //<S2SV> int rc ; //<S2SV> if ( ! mutt_bit_isset ( idata -> capabilities , ACRAM_MD5 ) ) //<S2SV> return IMAP_AUTH_UNAVAIL ; //<S2SV> mutt_message ( _ ( "Authenticating<S2SV_blank>(CRAM-MD5)..." ) ) ; //<S2SV> if ( mutt_account_getlogin ( & idata -> conn -> account ) < 0 ) //<S2SV> return IMAP_AUTH_FAILURE ; //<S2SV> if ( mutt_account_getpass ( & idata -> conn -> account ) < 0 ) //<S2SV> return IMAP_AUTH_FAILURE ; //<S2SV> imap_cmd_start ( idata , "AUTHENTICATE<S2SV_blank>CRAM-MD5" ) ; //<S2SV> do //<S2SV> rc = imap_cmd_step ( idata ) ; //<S2SV> while ( rc == IMAP_CMD_CONTINUE ) ; //<S2SV> if ( rc != IMAP_CMD_RESPOND ) //<S2SV> { //<S2SV> mutt_debug ( 1 , "Invalid<S2SV_blank>response<S2SV_blank>from<S2SV_blank>server:<S2SV_blank>%s\\n" , ibuf ) ; //<S2SV> goto bail ; //<S2SV> } //<S2SV> len = mutt_b64_decode ( obuf , idata -> buf + 2 ) ; //<S2SV> if ( len == - 1 ) //<S2SV> { //<S2SV> mutt_debug ( 1 , "Error<S2SV_blank>decoding<S2SV_blank>base64<S2SV_blank>response.\\n" ) ; //<S2SV> goto bail ; //<S2SV> } //<S2SV> obuf [ len ] = '\\0' ; //<S2SV> mutt_debug ( 2 , "CRAM<S2SV_blank>challenge:<S2SV_blank>%s\\n" , obuf ) ; //<S2SV> hmac_md5 ( idata -> conn -> account . pass , obuf , hmac_response ) ; //<S2SV> int off = snprintf ( obuf , sizeof ( obuf ) , "%s<S2SV_blank>" , idata -> conn -> account . user ) ; //<S2SV> mutt_md5_toascii ( hmac_response , obuf + off ) ; //<S2SV> mutt_debug ( 2 , "CRAM<S2SV_blank>response:<S2SV_blank>%s\\n" , obuf ) ; //<S2SV> mutt_b64_encode ( ibuf , obuf , strlen ( obuf ) , sizeof ( ibuf ) - 2 ) ; //<S2SV> mutt_str_strcat ( ibuf , sizeof ( ibuf ) , "\\r\\n" ) ; //<S2SV> mutt_socket_send ( idata -> conn , ibuf ) ; //<S2SV> do //<S2SV> rc = imap_cmd_step ( idata ) ; //<S2SV> while ( rc == IMAP_CMD_CONTINUE ) ; //<S2SV> if ( rc != IMAP_CMD_OK ) //<S2SV> { //<S2SV> mutt_debug ( 1 , "Error<S2SV_blank>receiving<S2SV_blank>server<S2SV_blank>response.\\n" ) ; //<S2SV> goto bail ; //<S2SV> } //<S2SV> if ( imap_code ( idata -> buf ) ) //<S2SV> return IMAP_AUTH_SUCCESS ; //<S2SV> bail : //<S2SV> mutt_error ( _ ( "CRAM-MD5<S2SV_blank>authentication<S2SV_blank>failed." ) ) ; //<S2SV> return IMAP_AUTH_FAILURE ; //<S2SV> } //<S2SV> 