int //<S2SV> server_partial_file_request ( struct httpd * env , struct client * clt , char * path , //<S2SV> struct stat * st , char * range_str ) //<S2SV> { //<S2SV> struct server_config * srv_conf = clt -> clt_srv_conf ; //<S2SV> struct http_descriptor * resp = clt -> clt_descresp ; //<S2SV> struct http_descriptor * desc = clt -> clt_descreq ; //<S2SV> struct media_type * media , multipart_media ; //<S2SV> struct range * range ; //<S2SV> struct evbuffer * evb = NULL ; //<S2SV> size_t content_length ; //<S2SV> int code = 500 , fd = - 1 , i , nranges , ret ; //<S2SV> uint32_t boundary ; //<S2SV> char content_range [ 64 ] ; //<S2SV> const char * errstr = NULL ; //<S2SV> if ( desc -> http_method != HTTP_METHOD_GET ) //<S2SV> return server_file_request ( env , clt , path , st ) ; //<S2SV> if ( ( range = parse_range ( range_str , st -> st_size , & nranges ) ) == NULL ) { //<S2SV> code = 416 ; //<S2SV> ( void ) snprintf ( content_range , sizeof ( content_range ) , //<S2SV> "bytes<S2SV_blank>*/%lld" , st -> st_size ) ; //<S2SV> errstr = content_range ; //<S2SV> goto abort ; //<S2SV> } //<S2SV> if ( ( fd = open ( path , O_RDONLY ) ) == - 1 ) //<S2SV> goto abort ; //<S2SV> media = media_find_config ( env , srv_conf , path ) ; //<S2SV> if ( ( evb = evbuffer_new ( ) ) == NULL ) { //<S2SV> errstr = "failed<S2SV_blank>to<S2SV_blank>allocate<S2SV_blank>file<S2SV_blank>buffer" ; //<S2SV> goto abort ; //<S2SV> } //<S2SV> if ( nranges == 1 ) { //<S2SV> ( void ) snprintf ( content_range , sizeof ( content_range ) , //<S2SV> "bytes<S2SV_blank>%lld-%lld/%lld" , range -> start , range -> end , //<S2SV> st -> st_size ) ; //<S2SV> if ( kv_add ( & resp -> http_headers , "Content-Range" , //<S2SV> content_range ) == NULL ) //<S2SV> goto abort ; //<S2SV> content_length = range -> end - range -> start + 1 ; //<S2SV> if ( buffer_add_range ( fd , evb , range ) == 0 ) //<S2SV> goto abort ; //<S2SV> } else { //<S2SV> content_length = 0 ; //<S2SV> boundary = arc4random ( ) ; //<S2SV> while ( nranges -- ) { //<S2SV> if ( ( i = evbuffer_add_printf ( evb , "\\r\\n--%ud\\r\\n" , //<S2SV> boundary ) ) == - 1 ) //<S2SV> goto abort ; //<S2SV> content_length += i ; //<S2SV> if ( ( i = evbuffer_add_printf ( evb , //<S2SV> "Content-Type:<S2SV_blank>%s/%s\\r\\n" , //<S2SV> media -> media_type , media -> media_subtype ) ) == - 1 ) //<S2SV> goto abort ; //<S2SV> content_length += i ; //<S2SV> if ( ( i = evbuffer_add_printf ( evb , //<S2SV> "Content-Range:<S2SV_blank>bytes<S2SV_blank>%lld-%lld/%lld\\r\\n\\r\\n" , //<S2SV> range -> start , range -> end , st -> st_size ) ) == - 1 ) //<S2SV> goto abort ; //<S2SV> content_length += i ; //<S2SV> if ( buffer_add_range ( fd , evb , range ) == 0 ) //<S2SV> goto abort ; //<S2SV> content_length += range -> end - range -> start + 1 ; //<S2SV> range ++ ; //<S2SV> } //<S2SV> if ( ( i = evbuffer_add_printf ( evb , "\\r\\n--%ud--\\r\\n" , //<S2SV> boundary ) ) == - 1 ) //<S2SV> goto abort ; //<S2SV> content_length += i ; //<S2SV> ( void ) strlcpy ( multipart_media . media_type , "multipart" , //<S2SV> sizeof ( multipart_media . media_type ) ) ; //<S2SV> ( void ) snprintf ( multipart_media . media_subtype , //<S2SV> sizeof ( multipart_media . media_subtype ) , //<S2SV> "byteranges;<S2SV_blank>boundary=%ud" , boundary ) ; //<S2SV> media = & multipart_media ; //<S2SV> } //<S2SV> close ( fd ) ; //<S2SV> fd = - 1 ; //<S2SV> ret = server_response_http ( clt , 206 , media , content_length , //<S2SV> MINIMUM ( time ( NULL ) , st -> st_mtim . tv_sec ) ) ; //<S2SV> switch ( ret ) { //<S2SV> case - 1 : //<S2SV> goto fail ; //<S2SV> case 0 : //<S2SV> goto done ; //<S2SV> default : //<S2SV> break ; //<S2SV> } //<S2SV> if ( server_bufferevent_write_buffer ( clt , evb ) == - 1 ) //<S2SV> goto fail ; //<S2SV> bufferevent_enable ( clt -> clt_bev , EV_READ | EV_WRITE ) ; //<S2SV> if ( clt -> clt_persist ) //<S2SV> clt -> clt_toread = TOREAD_HTTP_HEADER ; //<S2SV> else //<S2SV> clt -> clt_toread = TOREAD_HTTP_NONE ; //<S2SV> clt -> clt_done = 0 ; //<S2SV> done : //<S2SV> evbuffer_free ( evb ) ; //<S2SV> server_reset_http ( clt ) ; //<S2SV> return ( 0 ) ; //<S2SV> fail : //<S2SV> bufferevent_disable ( clt -> clt_bev , EV_READ | EV_WRITE ) ; //<S2SV> bufferevent_free ( clt -> clt_bev ) ; //<S2SV> clt -> clt_bev = NULL ; //<S2SV> abort : //<S2SV> if ( evb != NULL ) //<S2SV> evbuffer_free ( evb ) ; //<S2SV> if ( fd != - 1 ) //<S2SV> close ( fd ) ; //<S2SV> if ( errstr == NULL ) //<S2SV> errstr = strerror ( errno ) ; //<S2SV> server_abort_http ( clt , code , errstr ) ; //<S2SV> return ( - 1 ) ; //<S2SV> } //<S2SV> 