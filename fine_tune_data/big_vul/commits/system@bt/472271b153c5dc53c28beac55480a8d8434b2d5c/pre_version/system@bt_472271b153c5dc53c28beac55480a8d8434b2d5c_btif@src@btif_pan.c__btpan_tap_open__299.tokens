int btpan_tap_open ( ) //<S2SV> { //<S2SV> struct ifreq ifr ; //<S2SV> int fd , err ; //<S2SV> const char * clonedev = "/dev/tun" ; //<S2SV> if ( ( fd = open ( clonedev , O_RDWR ) ) < 0 ) //<S2SV> { //<S2SV> BTIF_TRACE_DEBUG ( "could<S2SV_blank>not<S2SV_blank>open<S2SV_blank>%s,<S2SV_blank>err:%d" , clonedev , errno ) ; //<S2SV> return fd ; //<S2SV> } //<S2SV> memset ( & ifr , 0 , sizeof ( ifr ) ) ; //<S2SV> ifr . ifr_flags = IFF_TAP | IFF_NO_PI ; //<S2SV> strncpy ( ifr . ifr_name , TAP_IF_NAME , IFNAMSIZ ) ; //<S2SV> if ( ( err = ioctl ( fd , TUNSETIFF , ( void * ) & ifr ) ) < 0 ) //<S2SV> { //<S2SV> BTIF_TRACE_DEBUG ( "ioctl<S2SV_blank>error:%d,<S2SV_blank>errno:%s" , err , strerror ( errno ) ) ; //<S2SV> close ( fd ) ; //<S2SV> return err ; //<S2SV> } //<S2SV> if ( tap_if_up ( TAP_IF_NAME , controller_get_interface ( ) -> get_address ( ) ) == 0 ) //<S2SV> { //<S2SV> int flags = fcntl ( fd , F_GETFL , 0 ) ; //<S2SV> fcntl ( fd , F_SETFL , flags | O_NONBLOCK ) ; //<S2SV> return fd ; //<S2SV> } //<S2SV> BTIF_TRACE_ERROR ( "can<S2SV_blank>not<S2SV_blank>bring<S2SV_blank>up<S2SV_blank>tap<S2SV_blank>interface:%s" , TAP_IF_NAME ) ; //<S2SV> close ( fd ) ; //<S2SV> return INVALID_FD ; //<S2SV> } //<S2SV> 