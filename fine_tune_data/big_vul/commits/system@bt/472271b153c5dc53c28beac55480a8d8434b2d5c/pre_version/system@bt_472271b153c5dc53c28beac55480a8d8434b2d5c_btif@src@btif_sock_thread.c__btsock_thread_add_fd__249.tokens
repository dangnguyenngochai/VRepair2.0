int btsock_thread_add_fd ( int h , int fd , int type , int flags , uint32_t user_id ) //<S2SV> { //<S2SV> if ( h < 0 || h >= MAX_THREAD ) //<S2SV> { //<S2SV> APPL_TRACE_ERROR ( "invalid<S2SV_blank>bt<S2SV_blank>thread<S2SV_blank>handle:%d" , h ) ; //<S2SV> return FALSE ; //<S2SV> } //<S2SV> if ( ts [ h ] . cmd_fdw == - 1 ) //<S2SV> { //<S2SV> APPL_TRACE_ERROR ( "cmd<S2SV_blank>socket<S2SV_blank>is<S2SV_blank>not<S2SV_blank>created.<S2SV_blank>socket<S2SV_blank>thread<S2SV_blank>may<S2SV_blank>not<S2SV_blank>initialized" ) ; //<S2SV> return FALSE ; //<S2SV> } //<S2SV> if ( flags & SOCK_THREAD_ADD_FD_SYNC ) //<S2SV> { //<S2SV> if ( ts [ h ] . thread_id == pthread_self ( ) ) //<S2SV> { //<S2SV> flags &= ~ SOCK_THREAD_ADD_FD_SYNC ; //<S2SV> add_poll ( h , fd , type , flags , user_id ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> APPL_TRACE_DEBUG ( "THREAD_ADD_FD_SYNC<S2SV_blank>is<S2SV_blank>not<S2SV_blank>called<S2SV_blank>in<S2SV_blank>poll<S2SV_blank>thread,<S2SV_blank>fallback<S2SV_blank>to<S2SV_blank>async" ) ; //<S2SV> } //<S2SV> sock_cmd_t cmd = { CMD_ADD_FD , fd , type , flags , user_id } ; //<S2SV> APPL_TRACE_DEBUG ( "adding<S2SV_blank>fd:%d,<S2SV_blank>flags:0x%x" , fd , flags ) ; //<S2SV> return send ( ts [ h ] . cmd_fdw , & cmd , sizeof ( cmd ) , 0 ) == sizeof ( cmd ) ; //<S2SV> } //<S2SV> 