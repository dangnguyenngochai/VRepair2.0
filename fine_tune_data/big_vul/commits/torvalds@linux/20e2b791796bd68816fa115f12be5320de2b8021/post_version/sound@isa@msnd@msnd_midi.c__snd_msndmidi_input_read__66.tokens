void snd_msndmidi_input_read ( void * mpuv ) //<S2SV> { //<S2SV> unsigned long flags ; //<S2SV> struct snd_msndmidi * mpu = mpuv ; //<S2SV> void * pwMIDQData = mpu -> dev -> mappedbase + MIDQ_DATA_BUFF ; //<S2SV> u16 head , tail , size ; //<S2SV> spin_lock_irqsave ( & mpu -> input_lock , flags ) ; //<S2SV> head = readw ( mpu -> dev -> MIDQ + JQS_wHead ) ; //<S2SV> tail = readw ( mpu -> dev -> MIDQ + JQS_wTail ) ; //<S2SV> size = readw ( mpu -> dev -> MIDQ + JQS_wSize ) ; //<S2SV> if ( head > size || tail > size ) //<S2SV> goto out ; //<S2SV> while ( head != tail ) { //<S2SV> unsigned char val = readw ( pwMIDQData + 2 * head ) ; //<S2SV> if ( test_bit ( MSNDMIDI_MODE_BIT_INPUT_TRIGGER , & mpu -> mode ) ) //<S2SV> snd_rawmidi_receive ( mpu -> substream_input , & val , 1 ) ; //<S2SV> if ( ++ head > size ) //<S2SV> head = 0 ; //<S2SV> writew ( head , mpu -> dev -> MIDQ + JQS_wHead ) ; //<S2SV> } //<S2SV> out : //<S2SV> spin_unlock_irqrestore ( & mpu -> input_lock , flags ) ; //<S2SV> } //<S2SV> 