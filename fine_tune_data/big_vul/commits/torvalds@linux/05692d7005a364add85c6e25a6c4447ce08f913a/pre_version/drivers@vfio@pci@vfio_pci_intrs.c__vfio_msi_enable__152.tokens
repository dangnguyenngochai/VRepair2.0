static int vfio_msi_enable ( struct vfio_pci_device * vdev , int nvec , bool msix ) //<S2SV> { //<S2SV> struct pci_dev * pdev = vdev -> pdev ; //<S2SV> unsigned int flag = msix ? PCI_IRQ_MSIX : PCI_IRQ_MSI ; //<S2SV> int ret ; //<S2SV> if ( ! is_irq_none ( vdev ) ) //<S2SV> return - EINVAL ; //<S2SV> vdev -> ctx = kzalloc ( nvec * sizeof ( struct vfio_pci_irq_ctx ) , GFP_KERNEL ) ; //<S2SV> if ( ! vdev -> ctx ) //<S2SV> return - ENOMEM ; //<S2SV> ret = pci_alloc_irq_vectors ( pdev , 1 , nvec , flag ) ; //<S2SV> if ( ret < nvec ) { //<S2SV> if ( ret > 0 ) //<S2SV> pci_free_irq_vectors ( pdev ) ; //<S2SV> kfree ( vdev -> ctx ) ; //<S2SV> return ret ; //<S2SV> } //<S2SV> vdev -> num_ctx = nvec ; //<S2SV> vdev -> irq_type = msix ? VFIO_PCI_MSIX_IRQ_INDEX : //<S2SV> VFIO_PCI_MSI_IRQ_INDEX ; //<S2SV> if ( ! msix ) { //<S2SV> vdev -> msi_qmax = fls ( nvec * 2 - 1 ) - 1 ; //<S2SV> } //<S2SV> return 0 ; //<S2SV> } //<S2SV> 