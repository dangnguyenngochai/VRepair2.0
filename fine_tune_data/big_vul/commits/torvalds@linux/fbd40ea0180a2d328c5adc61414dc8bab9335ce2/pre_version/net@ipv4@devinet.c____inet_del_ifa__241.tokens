static void __inet_del_ifa ( struct in_device * in_dev , struct in_ifaddr * * ifap , //<S2SV> int destroy , struct nlmsghdr * nlh , u32 portid ) //<S2SV> { //<S2SV> struct in_ifaddr * promote = NULL ; //<S2SV> struct in_ifaddr * ifa , * ifa1 = * ifap ; //<S2SV> struct in_ifaddr * last_prim = in_dev -> ifa_list ; //<S2SV> struct in_ifaddr * prev_prom = NULL ; //<S2SV> int do_promote = IN_DEV_PROMOTE_SECONDARIES ( in_dev ) ; //<S2SV> ASSERT_RTNL ( ) ; //<S2SV> if ( ! ( ifa1 -> ifa_flags & IFA_F_SECONDARY ) ) { //<S2SV> struct in_ifaddr * * ifap1 = & ifa1 -> ifa_next ; //<S2SV> while ( ( ifa = * ifap1 ) != NULL ) { //<S2SV> if ( ! ( ifa -> ifa_flags & IFA_F_SECONDARY ) && //<S2SV> ifa1 -> ifa_scope <= ifa -> ifa_scope ) //<S2SV> last_prim = ifa ; //<S2SV> if ( ! ( ifa -> ifa_flags & IFA_F_SECONDARY ) || //<S2SV> ifa1 -> ifa_mask != ifa -> ifa_mask || //<S2SV> ! inet_ifa_match ( ifa1 -> ifa_address , ifa ) ) { //<S2SV> ifap1 = & ifa -> ifa_next ; //<S2SV> prev_prom = ifa ; //<S2SV> continue ; //<S2SV> } //<S2SV> if ( ! do_promote ) { //<S2SV> inet_hash_remove ( ifa ) ; //<S2SV> * ifap1 = ifa -> ifa_next ; //<S2SV> rtmsg_ifa ( RTM_DELADDR , ifa , nlh , portid ) ; //<S2SV> blocking_notifier_call_chain ( & inetaddr_chain , //<S2SV> NETDEV_DOWN , ifa ) ; //<S2SV> inet_free_ifa ( ifa ) ; //<S2SV> } else { //<S2SV> promote = ifa ; //<S2SV> break ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> for ( ifa = promote ; ifa ; ifa = ifa -> ifa_next ) { //<S2SV> if ( ifa1 -> ifa_mask == ifa -> ifa_mask && //<S2SV> inet_ifa_match ( ifa1 -> ifa_address , ifa ) ) //<S2SV> fib_del_ifaddr ( ifa , ifa1 ) ; //<S2SV> } //<S2SV> * ifap = ifa1 -> ifa_next ; //<S2SV> inet_hash_remove ( ifa1 ) ; //<S2SV> rtmsg_ifa ( RTM_DELADDR , ifa1 , nlh , portid ) ; //<S2SV> blocking_notifier_call_chain ( & inetaddr_chain , NETDEV_DOWN , ifa1 ) ; //<S2SV> if ( promote ) { //<S2SV> struct in_ifaddr * next_sec = promote -> ifa_next ; //<S2SV> if ( prev_prom ) { //<S2SV> prev_prom -> ifa_next = promote -> ifa_next ; //<S2SV> promote -> ifa_next = last_prim -> ifa_next ; //<S2SV> last_prim -> ifa_next = promote ; //<S2SV> } //<S2SV> promote -> ifa_flags &= ~ IFA_F_SECONDARY ; //<S2SV> rtmsg_ifa ( RTM_NEWADDR , promote , nlh , portid ) ; //<S2SV> blocking_notifier_call_chain ( & inetaddr_chain , //<S2SV> NETDEV_UP , promote ) ; //<S2SV> for ( ifa = next_sec ; ifa ; ifa = ifa -> ifa_next ) { //<S2SV> if ( ifa1 -> ifa_mask != ifa -> ifa_mask || //<S2SV> ! inet_ifa_match ( ifa1 -> ifa_address , ifa ) ) //<S2SV> continue ; //<S2SV> fib_add_ifaddr ( ifa ) ; //<S2SV> } //<S2SV> } //<S2SV> if ( destroy ) //<S2SV> inet_free_ifa ( ifa1 ) ; //<S2SV> } //<S2SV> 