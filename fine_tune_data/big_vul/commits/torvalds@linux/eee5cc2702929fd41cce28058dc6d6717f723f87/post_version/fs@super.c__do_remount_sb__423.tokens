int do_remount_sb ( struct super_block * sb , int flags , void * data , int force ) //<S2SV> { //<S2SV> int retval ; //<S2SV> int remount_ro ; //<S2SV> if ( sb -> s_writers . frozen != SB_UNFROZEN ) //<S2SV> return - EBUSY ; //<S2SV> # ifdef CONFIG_BLOCK //<S2SV> if ( ! ( flags & MS_RDONLY ) && bdev_read_only ( sb -> s_bdev ) ) //<S2SV> return - EACCES ; //<S2SV> # endif //<S2SV> if ( flags & MS_RDONLY ) //<S2SV> acct_auto_close ( sb ) ; //<S2SV> shrink_dcache_sb ( sb ) ; //<S2SV> sync_filesystem ( sb ) ; //<S2SV> remount_ro = ( flags & MS_RDONLY ) && ! ( sb -> s_flags & MS_RDONLY ) ; //<S2SV> if ( remount_ro ) { //<S2SV> if ( force ) { //<S2SV> sb -> s_readonly_remount = 1 ; //<S2SV> smp_wmb ( ) ; //<S2SV> } else { //<S2SV> retval = sb_prepare_remount_readonly ( sb ) ; //<S2SV> if ( retval ) //<S2SV> return retval ; //<S2SV> } //<S2SV> } //<S2SV> if ( sb -> s_op -> remount_fs ) { //<S2SV> retval = sb -> s_op -> remount_fs ( sb , & flags , data ) ; //<S2SV> if ( retval ) { //<S2SV> if ( ! force ) //<S2SV> goto cancel_readonly ; //<S2SV> WARN ( 1 , "forced<S2SV_blank>remount<S2SV_blank>of<S2SV_blank>a<S2SV_blank>%s<S2SV_blank>fs<S2SV_blank>returned<S2SV_blank>%i\\n" , //<S2SV> sb -> s_type -> name , retval ) ; //<S2SV> } //<S2SV> } //<S2SV> sb -> s_flags = ( sb -> s_flags & ~ MS_RMT_MASK ) | ( flags & MS_RMT_MASK ) ; //<S2SV> smp_wmb ( ) ; //<S2SV> sb -> s_readonly_remount = 0 ; //<S2SV> if ( remount_ro && sb -> s_bdev ) //<S2SV> invalidate_bdev ( sb -> s_bdev ) ; //<S2SV> return 0 ; //<S2SV> cancel_readonly : //<S2SV> sb -> s_readonly_remount = 0 ; //<S2SV> return retval ; //<S2SV> } //<S2SV> 