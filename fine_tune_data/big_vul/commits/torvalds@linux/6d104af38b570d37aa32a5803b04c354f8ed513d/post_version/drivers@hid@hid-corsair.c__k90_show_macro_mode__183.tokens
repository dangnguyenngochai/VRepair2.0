static ssize_t k90_show_macro_mode ( struct device * dev , //<S2SV> struct device_attribute * attr , char * buf ) //<S2SV> { //<S2SV> int ret ; //<S2SV> struct usb_interface * usbif = to_usb_interface ( dev -> parent ) ; //<S2SV> struct usb_device * usbdev = interface_to_usbdev ( usbif ) ; //<S2SV> const char * macro_mode ; //<S2SV> char * data ; //<S2SV> data = kmalloc ( 2 , GFP_KERNEL ) ; //<S2SV> if ( ! data ) //<S2SV> return - ENOMEM ; //<S2SV> ret = usb_control_msg ( usbdev , usb_rcvctrlpipe ( usbdev , 0 ) , //<S2SV> K90_REQUEST_GET_MODE , //<S2SV> USB_DIR_IN | USB_TYPE_VENDOR | //<S2SV> USB_RECIP_DEVICE , 0 , 0 , data , 2 , //<S2SV> USB_CTRL_SET_TIMEOUT ) ; //<S2SV> if ( ret < 0 ) { //<S2SV> dev_warn ( dev , "Failed<S2SV_blank>to<S2SV_blank>get<S2SV_blank>K90<S2SV_blank>initial<S2SV_blank>mode<S2SV_blank>(error<S2SV_blank>%d).\\n" , //<S2SV> ret ) ; //<S2SV> ret = - EIO ; //<S2SV> goto out ; //<S2SV> } //<S2SV> switch ( data [ 0 ] ) { //<S2SV> case K90_MACRO_MODE_HW : //<S2SV> macro_mode = "HW" ; //<S2SV> break ; //<S2SV> case K90_MACRO_MODE_SW : //<S2SV> macro_mode = "SW" ; //<S2SV> break ; //<S2SV> default : //<S2SV> dev_warn ( dev , "K90<S2SV_blank>in<S2SV_blank>unknown<S2SV_blank>mode:<S2SV_blank>%02hhx.\\n" , //<S2SV> data [ 0 ] ) ; //<S2SV> ret = - EIO ; //<S2SV> goto out ; //<S2SV> } //<S2SV> ret = snprintf ( buf , PAGE_SIZE , "%s\\n" , macro_mode ) ; //<S2SV> out : //<S2SV> kfree ( data ) ; //<S2SV> return ret ; //<S2SV> } //<S2SV> 