static void tg3_read_vpd ( struct tg3 * tp ) //<S2SV> { //<S2SV> u8 * vpd_data ; //<S2SV> unsigned int block_end , rosize , len ; //<S2SV> u32 vpdlen ; //<S2SV> int j , i = 0 ; //<S2SV> vpd_data = ( u8 * ) tg3_vpd_readblock ( tp , & vpdlen ) ; //<S2SV> if ( ! vpd_data ) //<S2SV> goto out_no_vpd ; //<S2SV> i = pci_vpd_find_tag ( vpd_data , 0 , vpdlen , PCI_VPD_LRDT_RO_DATA ) ; //<S2SV> if ( i < 0 ) //<S2SV> goto out_not_found ; //<S2SV> rosize = pci_vpd_lrdt_size ( & vpd_data [ i ] ) ; //<S2SV> block_end = i + PCI_VPD_LRDT_TAG_SIZE + rosize ; //<S2SV> i += PCI_VPD_LRDT_TAG_SIZE ; //<S2SV> if ( block_end > vpdlen ) //<S2SV> goto out_not_found ; //<S2SV> j = pci_vpd_find_info_keyword ( vpd_data , i , rosize , //<S2SV> PCI_VPD_RO_KEYWORD_MFR_ID ) ; //<S2SV> if ( j > 0 ) { //<S2SV> len = pci_vpd_info_field_size ( & vpd_data [ j ] ) ; //<S2SV> j += PCI_VPD_INFO_FLD_HDR_SIZE ; //<S2SV> if ( j + len > block_end || len != 4 || //<S2SV> memcmp ( & vpd_data [ j ] , "1028" , 4 ) ) //<S2SV> goto partno ; //<S2SV> j = pci_vpd_find_info_keyword ( vpd_data , i , rosize , //<S2SV> PCI_VPD_RO_KEYWORD_VENDOR0 ) ; //<S2SV> if ( j < 0 ) //<S2SV> goto partno ; //<S2SV> len = pci_vpd_info_field_size ( & vpd_data [ j ] ) ; //<S2SV> j += PCI_VPD_INFO_FLD_HDR_SIZE ; //<S2SV> if ( j + len > block_end ) //<S2SV> goto partno ; //<S2SV> memcpy ( tp -> fw_ver , & vpd_data [ j ] , len ) ; //<S2SV> strncat ( tp -> fw_ver , "<S2SV_blank>bc<S2SV_blank>" , vpdlen - len - 1 ) ; //<S2SV> } //<S2SV> partno : //<S2SV> i = pci_vpd_find_info_keyword ( vpd_data , i , rosize , //<S2SV> PCI_VPD_RO_KEYWORD_PARTNO ) ; //<S2SV> if ( i < 0 ) //<S2SV> goto out_not_found ; //<S2SV> len = pci_vpd_info_field_size ( & vpd_data [ i ] ) ; //<S2SV> i += PCI_VPD_INFO_FLD_HDR_SIZE ; //<S2SV> if ( len > TG3_BPN_SIZE || //<S2SV> ( len + i ) > vpdlen ) //<S2SV> goto out_not_found ; //<S2SV> memcpy ( tp -> board_part_number , & vpd_data [ i ] , len ) ; //<S2SV> out_not_found : //<S2SV> kfree ( vpd_data ) ; //<S2SV> if ( tp -> board_part_number [ 0 ] ) //<S2SV> return ; //<S2SV> out_no_vpd : //<S2SV> if ( tg3_asic_rev ( tp ) == ASIC_REV_5717 ) { //<S2SV> if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_5717 || //<S2SV> tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_5717_C ) //<S2SV> strcpy ( tp -> board_part_number , "BCM5717" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_5718 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM5718" ) ; //<S2SV> else //<S2SV> goto nomatch ; //<S2SV> } else if ( tg3_asic_rev ( tp ) == ASIC_REV_57780 ) { //<S2SV> if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57780 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57780" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57760 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57760" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57790 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57790" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57788 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57788" ) ; //<S2SV> else //<S2SV> goto nomatch ; //<S2SV> } else if ( tg3_asic_rev ( tp ) == ASIC_REV_57765 ) { //<S2SV> if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57761 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57761" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57765 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57765" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57781 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57781" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57785 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57785" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57791 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57791" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57795 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57795" ) ; //<S2SV> else //<S2SV> goto nomatch ; //<S2SV> } else if ( tg3_asic_rev ( tp ) == ASIC_REV_57766 ) { //<S2SV> if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57762 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57762" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57766 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57766" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57782 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57782" ) ; //<S2SV> else if ( tp -> pdev -> device == TG3PCI_DEVICE_TIGON3_57786 ) //<S2SV> strcpy ( tp -> board_part_number , "BCM57786" ) ; //<S2SV> else //<S2SV> goto nomatch ; //<S2SV> } else if ( tg3_asic_rev ( tp ) == ASIC_REV_5906 ) { //<S2SV> strcpy ( tp -> board_part_number , "BCM95906" ) ; //<S2SV> } else { //<S2SV> nomatch : //<S2SV> strcpy ( tp -> board_part_number , "none" ) ; //<S2SV> } //<S2SV> } //<S2SV> 