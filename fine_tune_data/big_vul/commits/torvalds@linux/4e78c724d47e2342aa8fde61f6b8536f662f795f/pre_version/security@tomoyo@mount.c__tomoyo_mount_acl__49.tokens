static int tomoyo_mount_acl ( struct tomoyo_request_info * r , char * dev_name , //<S2SV> struct path * dir , char * type , unsigned long flags ) //<S2SV> { //<S2SV> struct path path ; //<S2SV> struct file_system_type * fstype = NULL ; //<S2SV> const char * requested_type = NULL ; //<S2SV> const char * requested_dir_name = NULL ; //<S2SV> const char * requested_dev_name = NULL ; //<S2SV> struct tomoyo_path_info rtype ; //<S2SV> struct tomoyo_path_info rdev ; //<S2SV> struct tomoyo_path_info rdir ; //<S2SV> int need_dev = 0 ; //<S2SV> int error = - ENOMEM ; //<S2SV> requested_type = tomoyo_encode ( type ) ; //<S2SV> if ( ! requested_type ) //<S2SV> goto out ; //<S2SV> rtype . name = requested_type ; //<S2SV> tomoyo_fill_path_info ( & rtype ) ; //<S2SV> requested_dir_name = tomoyo_realpath_from_path ( dir ) ; //<S2SV> if ( ! requested_dir_name ) { //<S2SV> error = - ENOMEM ; //<S2SV> goto out ; //<S2SV> } //<S2SV> rdir . name = requested_dir_name ; //<S2SV> tomoyo_fill_path_info ( & rdir ) ; //<S2SV> if ( ! strcmp ( type , TOMOYO_MOUNT_REMOUNT_KEYWORD ) ) { //<S2SV> } else if ( ! strcmp ( type , TOMOYO_MOUNT_MAKE_UNBINDABLE_KEYWORD ) || //<S2SV> ! strcmp ( type , TOMOYO_MOUNT_MAKE_PRIVATE_KEYWORD ) || //<S2SV> ! strcmp ( type , TOMOYO_MOUNT_MAKE_SLAVE_KEYWORD ) || //<S2SV> ! strcmp ( type , TOMOYO_MOUNT_MAKE_SHARED_KEYWORD ) ) { //<S2SV> } else if ( ! strcmp ( type , TOMOYO_MOUNT_BIND_KEYWORD ) || //<S2SV> ! strcmp ( type , TOMOYO_MOUNT_MOVE_KEYWORD ) ) { //<S2SV> need_dev = - 1 ; //<S2SV> } else { //<S2SV> fstype = get_fs_type ( type ) ; //<S2SV> if ( ! fstype ) { //<S2SV> error = - ENODEV ; //<S2SV> goto out ; //<S2SV> } //<S2SV> if ( fstype -> fs_flags & FS_REQUIRES_DEV ) //<S2SV> need_dev = 1 ; //<S2SV> } //<S2SV> if ( need_dev ) { //<S2SV> if ( kern_path ( dev_name , LOOKUP_FOLLOW , & path ) ) { //<S2SV> error = - ENOENT ; //<S2SV> goto out ; //<S2SV> } //<S2SV> requested_dev_name = tomoyo_realpath_from_path ( & path ) ; //<S2SV> path_put ( & path ) ; //<S2SV> if ( ! requested_dev_name ) { //<S2SV> error = - ENOENT ; //<S2SV> goto out ; //<S2SV> } //<S2SV> } else { //<S2SV> if ( ! dev_name ) //<S2SV> dev_name = "<NULL>" ; //<S2SV> requested_dev_name = tomoyo_encode ( dev_name ) ; //<S2SV> if ( ! requested_dev_name ) { //<S2SV> error = - ENOMEM ; //<S2SV> goto out ; //<S2SV> } //<S2SV> } //<S2SV> rdev . name = requested_dev_name ; //<S2SV> tomoyo_fill_path_info ( & rdev ) ; //<S2SV> r -> param_type = TOMOYO_TYPE_MOUNT_ACL ; //<S2SV> r -> param . mount . need_dev = need_dev ; //<S2SV> r -> param . mount . dev = & rdev ; //<S2SV> r -> param . mount . dir = & rdir ; //<S2SV> r -> param . mount . type = & rtype ; //<S2SV> r -> param . mount . flags = flags ; //<S2SV> do { //<S2SV> tomoyo_check_acl ( r , tomoyo_check_mount_acl ) ; //<S2SV> error = tomoyo_audit_mount_log ( r ) ; //<S2SV> } while ( error == TOMOYO_RETRY_REQUEST ) ; //<S2SV> out : //<S2SV> kfree ( requested_dev_name ) ; //<S2SV> kfree ( requested_dir_name ) ; //<S2SV> if ( fstype ) //<S2SV> put_filesystem ( fstype ) ; //<S2SV> kfree ( requested_type ) ; //<S2SV> return error ; //<S2SV> } //<S2SV> 