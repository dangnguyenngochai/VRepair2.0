int utf8s_to_utf16s ( const u8 * s , int len , enum utf16_endian endian , //<S2SV> wchar_t * pwcs , int maxlen ) //<S2SV> { //<S2SV> u16 * op ; //<S2SV> int size ; //<S2SV> unicode_t u ; //<S2SV> op = pwcs ; //<S2SV> while ( len > 0 && maxlen > 0 && * s ) { //<S2SV> if ( * s & 0x80 ) { //<S2SV> size = utf8_to_utf32 ( s , len , & u ) ; //<S2SV> if ( size < 0 ) //<S2SV> return - EINVAL ; //<S2SV> s += size ; //<S2SV> len -= size ; //<S2SV> if ( u >= PLANE_SIZE ) { //<S2SV> if ( maxlen < 2 ) //<S2SV> break ; //<S2SV> u -= PLANE_SIZE ; //<S2SV> put_utf16 ( op ++ , SURROGATE_PAIR | //<S2SV> ( ( u >> 10 ) & SURROGATE_BITS ) , //<S2SV> endian ) ; //<S2SV> put_utf16 ( op ++ , SURROGATE_PAIR | //<S2SV> SURROGATE_LOW | //<S2SV> ( u & SURROGATE_BITS ) , //<S2SV> endian ) ; //<S2SV> maxlen -= 2 ; //<S2SV> } else { //<S2SV> put_utf16 ( op ++ , u , endian ) ; //<S2SV> maxlen -- ; //<S2SV> } //<S2SV> } else { //<S2SV> put_utf16 ( op ++ , * s ++ , endian ) ; //<S2SV> len -- ; //<S2SV> maxlen -- ; //<S2SV> } //<S2SV> } //<S2SV> return op - pwcs ; //<S2SV> } //<S2SV> 