CMD_FUNC ( m_authenticate ) //<S2SV> { //<S2SV> aClient * agent_p = NULL ; //<S2SV> if ( ! SASL_SERVER || ! MyConnect ( sptr ) || BadPtr ( parv [ 1 ] ) || ! CHECKPROTO ( sptr , PROTO_SASL ) ) //<S2SV> return 0 ; //<S2SV> if ( sptr -> local -> sasl_complete ) //<S2SV> { //<S2SV> sendto_one ( sptr , err_str ( ERR_SASLALREADY ) , me . name , BadPtr ( sptr -> name ) ? "*" : sptr -> name ) ; //<S2SV> return 0 ; //<S2SV> } //<S2SV> if ( strlen ( parv [ 1 ] ) > 400 ) //<S2SV> { //<S2SV> sendto_one ( sptr , err_str ( ERR_SASLTOOLONG ) , me . name , BadPtr ( sptr -> name ) ? "*" : sptr -> name ) ; //<S2SV> return 0 ; //<S2SV> } //<S2SV> if ( * sptr -> local -> sasl_agent ) //<S2SV> agent_p = find_client ( sptr -> local -> sasl_agent , NULL ) ; //<S2SV> if ( agent_p == NULL ) //<S2SV> { //<S2SV> char * addr = BadPtr ( sptr -> ip ) ? "0" : sptr -> ip ; //<S2SV> char * certfp = moddata_client_get ( sptr , "certfp" ) ; //<S2SV> sendto_server ( NULL , 0 , 0 , ":%s<S2SV_blank>SASL<S2SV_blank>%s<S2SV_blank>%s<S2SV_blank>H<S2SV_blank>%s<S2SV_blank>%s" , //<S2SV> me . name , SASL_SERVER , encode_puid ( sptr ) , addr , addr ) ; //<S2SV> if ( certfp ) //<S2SV> sendto_server ( NULL , 0 , 0 , ":%s<S2SV_blank>SASL<S2SV_blank>%s<S2SV_blank>%s<S2SV_blank>S<S2SV_blank>%s<S2SV_blank>%s" , //<S2SV> me . name , SASL_SERVER , encode_puid ( sptr ) , parv [ 1 ] , certfp ) ; //<S2SV> else //<S2SV> sendto_server ( NULL , 0 , 0 , ":%s<S2SV_blank>SASL<S2SV_blank>%s<S2SV_blank>%s<S2SV_blank>S<S2SV_blank>%s" , //<S2SV> me . name , SASL_SERVER , encode_puid ( sptr ) , parv [ 1 ] ) ; //<S2SV> } //<S2SV> else //<S2SV> sendto_server ( NULL , 0 , 0 , ":%s<S2SV_blank>SASL<S2SV_blank>%s<S2SV_blank>%s<S2SV_blank>C<S2SV_blank>%s" , //<S2SV> me . name , AGENT_SID ( agent_p ) , encode_puid ( sptr ) , parv [ 1 ] ) ; //<S2SV> sptr -> local -> sasl_out ++ ; //<S2SV> return 0 ; //<S2SV> } //<S2SV> 