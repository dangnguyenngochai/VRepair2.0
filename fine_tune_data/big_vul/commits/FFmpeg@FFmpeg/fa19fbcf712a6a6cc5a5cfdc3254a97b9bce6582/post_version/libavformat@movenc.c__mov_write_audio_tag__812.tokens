static int mov_write_audio_tag ( AVFormatContext * s , AVIOContext * pb , MOVMuxContext * mov , MOVTrack * track ) //<S2SV> { //<S2SV> int64_t pos = avio_tell ( pb ) ; //<S2SV> int version = 0 ; //<S2SV> uint32_t tag = track -> tag ; //<S2SV> if ( track -> mode == MODE_MOV ) { //<S2SV> if ( track -> timescale > UINT16_MAX || ! track -> par -> channels ) { //<S2SV> if ( mov_get_lpcm_flags ( track -> par -> codec_id ) ) //<S2SV> tag = AV_RL32 ( "lpcm" ) ; //<S2SV> version = 2 ; //<S2SV> } else if ( track -> audio_vbr || mov_pcm_le_gt16 ( track -> par -> codec_id ) || //<S2SV> mov_pcm_be_gt16 ( track -> par -> codec_id ) || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_ADPCM_MS || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_ADPCM_IMA_WAV || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_QDM2 ) { //<S2SV> version = 1 ; //<S2SV> } //<S2SV> } //<S2SV> avio_wb32 ( pb , 0 ) ; //<S2SV> if ( mov -> encryption_scheme != MOV_ENC_NONE ) { //<S2SV> ffio_wfourcc ( pb , "enca" ) ; //<S2SV> } else { //<S2SV> avio_wl32 ( pb , tag ) ; //<S2SV> } //<S2SV> avio_wb32 ( pb , 0 ) ; //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> avio_wb16 ( pb , 1 ) ; //<S2SV> avio_wb16 ( pb , version ) ; //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> avio_wb32 ( pb , 0 ) ; //<S2SV> if ( version == 2 ) { //<S2SV> avio_wb16 ( pb , 3 ) ; //<S2SV> avio_wb16 ( pb , 16 ) ; //<S2SV> avio_wb16 ( pb , 0xfffe ) ; //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> avio_wb32 ( pb , 0x00010000 ) ; //<S2SV> avio_wb32 ( pb , 72 ) ; //<S2SV> avio_wb64 ( pb , av_double2int ( track -> par -> sample_rate ) ) ; //<S2SV> avio_wb32 ( pb , track -> par -> channels ) ; //<S2SV> avio_wb32 ( pb , 0x7F000000 ) ; //<S2SV> avio_wb32 ( pb , av_get_bits_per_sample ( track -> par -> codec_id ) ) ; //<S2SV> avio_wb32 ( pb , mov_get_lpcm_flags ( track -> par -> codec_id ) ) ; //<S2SV> avio_wb32 ( pb , track -> sample_size ) ; //<S2SV> avio_wb32 ( pb , get_samples_per_packet ( track ) ) ; //<S2SV> } else { //<S2SV> if ( track -> mode == MODE_MOV ) { //<S2SV> avio_wb16 ( pb , track -> par -> channels ) ; //<S2SV> if ( track -> par -> codec_id == AV_CODEC_ID_PCM_U8 || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_PCM_S8 ) //<S2SV> avio_wb16 ( pb , 8 ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_ADPCM_G726 ) //<S2SV> avio_wb16 ( pb , track -> par -> bits_per_coded_sample ) ; //<S2SV> else //<S2SV> avio_wb16 ( pb , 16 ) ; //<S2SV> avio_wb16 ( pb , track -> audio_vbr ? - 2 : 0 ) ; //<S2SV> } else { //<S2SV> if ( track -> par -> codec_id == AV_CODEC_ID_FLAC || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_OPUS ) { //<S2SV> avio_wb16 ( pb , track -> par -> channels ) ; //<S2SV> } else { //<S2SV> avio_wb16 ( pb , 2 ) ; //<S2SV> } //<S2SV> if ( track -> par -> codec_id == AV_CODEC_ID_FLAC ) { //<S2SV> avio_wb16 ( pb , track -> par -> bits_per_raw_sample ) ; //<S2SV> } else { //<S2SV> avio_wb16 ( pb , 16 ) ; //<S2SV> } //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> } //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> if ( track -> par -> codec_id == AV_CODEC_ID_OPUS ) //<S2SV> avio_wb16 ( pb , 48000 ) ; //<S2SV> else //<S2SV> avio_wb16 ( pb , track -> par -> sample_rate <= UINT16_MAX ? //<S2SV> track -> par -> sample_rate : 0 ) ; //<S2SV> avio_wb16 ( pb , 0 ) ; //<S2SV> } //<S2SV> if ( version == 1 ) { //<S2SV> if ( mov_pcm_le_gt16 ( track -> par -> codec_id ) || //<S2SV> mov_pcm_be_gt16 ( track -> par -> codec_id ) ) //<S2SV> avio_wb32 ( pb , 1 ) ; //<S2SV> else //<S2SV> avio_wb32 ( pb , track -> par -> frame_size ) ; //<S2SV> avio_wb32 ( pb , track -> sample_size / track -> par -> channels ) ; //<S2SV> avio_wb32 ( pb , track -> sample_size ) ; //<S2SV> avio_wb32 ( pb , 2 ) ; //<S2SV> } //<S2SV> if ( track -> mode == MODE_MOV && //<S2SV> ( track -> par -> codec_id == AV_CODEC_ID_AAC || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_AC3 || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_EAC3 || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_AMR_NB || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_ALAC || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_ADPCM_MS || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_ADPCM_IMA_WAV || //<S2SV> track -> par -> codec_id == AV_CODEC_ID_QDM2 || //<S2SV> ( mov_pcm_le_gt16 ( track -> par -> codec_id ) && version == 1 ) || //<S2SV> ( mov_pcm_be_gt16 ( track -> par -> codec_id ) && version == 1 ) ) ) //<S2SV> mov_write_wave_tag ( s , pb , track ) ; //<S2SV> else if ( track -> tag == MKTAG ( 'm' , 'p' , '4' , 'a' ) ) //<S2SV> mov_write_esds_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_AMR_NB ) //<S2SV> mov_write_amr_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_AC3 ) //<S2SV> mov_write_ac3_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_EAC3 ) //<S2SV> mov_write_eac3_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_ALAC ) //<S2SV> mov_write_extradata_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_WMAPRO ) //<S2SV> mov_write_wfex_tag ( s , pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_FLAC ) //<S2SV> mov_write_dfla_tag ( pb , track ) ; //<S2SV> else if ( track -> par -> codec_id == AV_CODEC_ID_OPUS ) //<S2SV> mov_write_dops_tag ( pb , track ) ; //<S2SV> else if ( track -> vos_len > 0 ) //<S2SV> mov_write_glbl_tag ( pb , track ) ; //<S2SV> if ( track -> mode == MODE_MOV && track -> par -> codec_type == AVMEDIA_TYPE_AUDIO ) //<S2SV> mov_write_chan_tag ( s , pb , track ) ; //<S2SV> if ( mov -> encryption_scheme != MOV_ENC_NONE ) { //<S2SV> ff_mov_cenc_write_sinf_tag ( track , pb , mov -> encryption_kid ) ; //<S2SV> } //<S2SV> return update_size ( pb , pos ) ; //<S2SV> } //<S2SV> 