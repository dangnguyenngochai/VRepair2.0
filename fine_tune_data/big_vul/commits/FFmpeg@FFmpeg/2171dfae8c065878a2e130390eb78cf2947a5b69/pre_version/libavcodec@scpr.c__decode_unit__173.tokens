static int decode_unit ( SCPRContext * s , PixelModel * pixel , unsigned step , unsigned * rval ) //<S2SV> { //<S2SV> GetByteContext * gb = & s -> gb ; //<S2SV> RangeCoder * rc = & s -> rc ; //<S2SV> unsigned totfr = pixel -> total_freq ; //<S2SV> unsigned value , x = 0 , cumfr = 0 , cnt_x = 0 ; //<S2SV> int i , j , ret , c , cnt_c ; //<S2SV> if ( ( ret = s -> get_freq ( rc , totfr , & value ) ) < 0 ) //<S2SV> return ret ; //<S2SV> while ( x < 16 ) { //<S2SV> cnt_x = pixel -> lookup [ x ] ; //<S2SV> if ( value >= cumfr + cnt_x ) //<S2SV> cumfr += cnt_x ; //<S2SV> else //<S2SV> break ; //<S2SV> x ++ ; //<S2SV> } //<S2SV> c = x * 16 ; //<S2SV> cnt_c = 0 ; //<S2SV> while ( c < 256 ) { //<S2SV> cnt_c = pixel -> freq [ c ] ; //<S2SV> if ( value >= cumfr + cnt_c ) //<S2SV> cumfr += cnt_c ; //<S2SV> else //<S2SV> break ; //<S2SV> c ++ ; //<S2SV> } //<S2SV> if ( ( ret = s -> decode ( gb , rc , cumfr , cnt_c , totfr ) ) < 0 ) //<S2SV> return ret ; //<S2SV> pixel -> freq [ c ] = cnt_c + step ; //<S2SV> pixel -> lookup [ x ] = cnt_x + step ; //<S2SV> totfr += step ; //<S2SV> if ( totfr > BOT ) { //<S2SV> totfr = 0 ; //<S2SV> for ( i = 0 ; i < 256 ; i ++ ) { //<S2SV> unsigned nc = ( pixel -> freq [ i ] >> 1 ) + 1 ; //<S2SV> pixel -> freq [ i ] = nc ; //<S2SV> totfr += nc ; //<S2SV> } //<S2SV> for ( i = 0 ; i < 16 ; i ++ ) { //<S2SV> unsigned sum = 0 ; //<S2SV> unsigned i16_17 = i << 4 ; //<S2SV> for ( j = 0 ; j < 16 ; j ++ ) //<S2SV> sum += pixel -> freq [ i16_17 + j ] ; //<S2SV> pixel -> lookup [ i ] = sum ; //<S2SV> } //<S2SV> } //<S2SV> pixel -> total_freq = totfr ; //<S2SV> * rval = c & s -> cbits ; //<S2SV> return 0 ; //<S2SV> } //<S2SV> 