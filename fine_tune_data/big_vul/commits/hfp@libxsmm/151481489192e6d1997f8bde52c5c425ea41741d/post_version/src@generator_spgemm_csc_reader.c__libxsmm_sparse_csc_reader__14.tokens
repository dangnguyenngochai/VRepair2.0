LIBXSMM_API_INTERN //<S2SV> void libxsmm_sparse_csc_reader ( libxsmm_generated_code * io_generated_code , //<S2SV> const char * i_csc_file_in , //<S2SV> unsigned int * * o_row_idx , //<S2SV> unsigned int * * o_column_idx , //<S2SV> double * * o_values , //<S2SV> unsigned int * o_row_count , //<S2SV> unsigned int * o_column_count , //<S2SV> unsigned int * o_element_count ) { //<S2SV> FILE * l_csc_file_handle ; //<S2SV> const unsigned int l_line_length = 512 ; //<S2SV> char l_line [ 512 + 1 ] ; //<S2SV> unsigned int l_header_read = 0 ; //<S2SV> unsigned int * l_column_idx_id = NULL ; //<S2SV> unsigned int l_i = 0 ; //<S2SV> l_csc_file_handle = fopen ( i_csc_file_in , "r" ) ; //<S2SV> if ( l_csc_file_handle == NULL ) { //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_INPUT ) ; //<S2SV> return ; //<S2SV> } //<S2SV> while ( fgets ( l_line , l_line_length , l_csc_file_handle ) != NULL ) { //<S2SV> if ( strlen ( l_line ) == l_line_length ) { //<S2SV> free ( * o_row_idx ) ; free ( * o_column_idx ) ; free ( * o_values ) ; free ( l_column_idx_id ) ; //<S2SV> * o_row_idx = 0 ; * o_column_idx = 0 ; * o_values = 0 ; //<S2SV> fclose ( l_csc_file_handle ) ; //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_READ_LEN ) ; //<S2SV> return ; //<S2SV> } //<S2SV> if ( l_line [ 0 ] == '%' ) { //<S2SV> continue ; //<S2SV> } else { //<S2SV> if ( l_header_read == 0 ) { //<S2SV> if ( 3 == sscanf ( l_line , "%u<S2SV_blank>%u<S2SV_blank>%u" , o_row_count , o_column_count , o_element_count ) && //<S2SV> 0 != * o_row_count && 0 != * o_column_count && 0 != * o_element_count ) //<S2SV> { //<S2SV> * o_row_idx = ( unsigned int * ) malloc ( sizeof ( unsigned int ) * ( * o_element_count ) ) ; //<S2SV> * o_column_idx = ( unsigned int * ) malloc ( sizeof ( unsigned int ) * ( ( size_t ) ( * o_column_count ) + 1 ) ) ; //<S2SV> * o_values = ( double * ) malloc ( sizeof ( double ) * ( * o_element_count ) ) ; //<S2SV> l_column_idx_id = ( unsigned int * ) malloc ( sizeof ( unsigned int ) * ( * o_column_count ) ) ; //<S2SV> if ( ( * o_row_idx == NULL ) || //<S2SV> ( * o_column_idx == NULL ) || //<S2SV> ( * o_values == NULL ) || //<S2SV> ( l_column_idx_id == NULL ) ) { //<S2SV> free ( * o_row_idx ) ; free ( * o_column_idx ) ; free ( * o_values ) ; free ( l_column_idx_id ) ; //<S2SV> * o_row_idx = 0 ; * o_column_idx = 0 ; * o_values = 0 ; //<S2SV> fclose ( l_csc_file_handle ) ; //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_ALLOC_DATA ) ; //<S2SV> return ; //<S2SV> } //<S2SV> memset ( * o_row_idx , 0 , sizeof ( unsigned int ) * ( * o_element_count ) ) ; //<S2SV> memset ( * o_column_idx , 0 , sizeof ( unsigned int ) * ( ( size_t ) ( * o_column_count ) + 1 ) ) ; //<S2SV> memset ( * o_values , 0 , sizeof ( double ) * ( * o_element_count ) ) ; //<S2SV> memset ( l_column_idx_id , 0 , sizeof ( unsigned int ) * ( * o_column_count ) ) ; //<S2SV> for ( l_i = 0 ; l_i <= * o_column_count ; ++ l_i ) { //<S2SV> ( * o_column_idx ) [ l_i ] = * o_element_count ; //<S2SV> } //<S2SV> ( * o_column_idx ) [ 0 ] = 0 ; //<S2SV> l_i = 0 ; //<S2SV> l_header_read = 1 ; //<S2SV> } else { //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_READ_DESC ) ; //<S2SV> fclose ( l_csc_file_handle ) ; //<S2SV> return ; //<S2SV> } //<S2SV> } else { //<S2SV> unsigned int l_row = 0 , l_column = 0 ; //<S2SV> double l_value = 0 ; //<S2SV> if ( sscanf ( l_line , "%u<S2SV_blank>%u<S2SV_blank>%lf" , & l_row , & l_column , & l_value ) != 3 ) { //<S2SV> free ( * o_row_idx ) ; free ( * o_column_idx ) ; free ( * o_values ) ; free ( l_column_idx_id ) ; //<S2SV> * o_row_idx = 0 ; * o_column_idx = 0 ; * o_values = 0 ; //<S2SV> fclose ( l_csc_file_handle ) ; //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_READ_ELEMS ) ; //<S2SV> return ; //<S2SV> } //<S2SV> LIBXSMM_ASSERT ( 0 != l_row && 0 != l_column ) ; //<S2SV> l_row -- ; l_column -- ; //<S2SV> ( * o_row_idx ) [ l_i ] = l_row ; //<S2SV> ( * o_values ) [ l_i ] = l_value ; //<S2SV> l_i ++ ; //<S2SV> l_column_idx_id [ l_column ] = 1 ; //<S2SV> ( * o_column_idx ) [ l_column + 1 ] = l_i ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> fclose ( l_csc_file_handle ) ; //<S2SV> if ( l_i != ( * o_element_count ) ) { //<S2SV> free ( * o_row_idx ) ; free ( * o_column_idx ) ; free ( * o_values ) ; free ( l_column_idx_id ) ; //<S2SV> * o_row_idx = 0 ; * o_column_idx = 0 ; * o_values = 0 ; //<S2SV> LIBXSMM_HANDLE_ERROR ( io_generated_code , LIBXSMM_ERR_CSC_LEN ) ; //<S2SV> return ; //<S2SV> } //<S2SV> if ( l_column_idx_id != NULL ) { //<S2SV> for ( l_i = 0 ; l_i < ( * o_column_count ) ; l_i ++ ) { //<S2SV> if ( l_column_idx_id [ l_i ] == 0 ) { //<S2SV> ( * o_column_idx ) [ l_i + 1 ] = ( * o_column_idx ) [ l_i ] ; //<S2SV> } //<S2SV> } //<S2SV> free ( l_column_idx_id ) ; //<S2SV> } //<S2SV> } //<S2SV> 