jp2_box_t * jp2_box_get ( jas_stream_t * in ) //<S2SV> { //<S2SV> jp2_box_t * box ; //<S2SV> jp2_boxinfo_t * boxinfo ; //<S2SV> jas_stream_t * tmpstream ; //<S2SV> uint_fast32_t len ; //<S2SV> uint_fast64_t extlen ; //<S2SV> bool dataflag ; //<S2SV> box = 0 ; //<S2SV> tmpstream = 0 ; //<S2SV> if ( ! ( box = jas_malloc ( sizeof ( jp2_box_t ) ) ) ) { //<S2SV> goto error ; //<S2SV> } //<S2SV> box -> ops = & jp2_boxinfo_unk . ops ; //<S2SV> if ( jp2_getuint32 ( in , & len ) || jp2_getuint32 ( in , & box -> type ) ) { //<S2SV> goto error ; //<S2SV> } //<S2SV> boxinfo = jp2_boxinfolookup ( box -> type ) ; //<S2SV> box -> info = boxinfo ; //<S2SV> box -> ops = & boxinfo -> ops ; //<S2SV> box -> len = len ; //<S2SV> JAS_DBGLOG ( 10 , ( //<S2SV> "preliminary<S2SV_blank>processing<S2SV_blank>of<S2SV_blank>JP2<S2SV_blank>box:<S2SV_blank>type=%c%s%c<S2SV_blank>(0x%08x);<S2SV_blank>length=%d\\n" , //<S2SV> \'"\' , boxinfo -> name , \'"\' , box -> type , box -> len //<S2SV> ) ) ; //<S2SV> if ( box -> len == 1 ) { //<S2SV> if ( jp2_getuint64 ( in , & extlen ) ) { //<S2SV> goto error ; //<S2SV> } //<S2SV> if ( extlen > 0xffffffffUL ) { //<S2SV> jas_eprintf ( "warning:<S2SV_blank>cannot<S2SV_blank>handle<S2SV_blank>large<S2SV_blank>64-bit<S2SV_blank>box<S2SV_blank>length\\n" ) ; //<S2SV> extlen = 0xffffffffUL ; //<S2SV> } //<S2SV> box -> len = extlen ; //<S2SV> box -> datalen = extlen - JP2_BOX_HDRLEN ( true ) ; //<S2SV> } else { //<S2SV> box -> datalen = box -> len - JP2_BOX_HDRLEN ( false ) ; //<S2SV> } //<S2SV> if ( box -> len != 0 && box -> len < 8 ) { //<S2SV> goto error ; //<S2SV> } //<S2SV> dataflag = ! ( box -> info -> flags & ( JP2_BOX_SUPER | JP2_BOX_NODATA ) ) ; //<S2SV> if ( dataflag ) { //<S2SV> if ( ! ( tmpstream = jas_stream_memopen ( 0 , 0 ) ) ) { //<S2SV> goto error ; //<S2SV> } //<S2SV> if ( jas_stream_copy ( tmpstream , in , box -> datalen ) ) { //<S2SV> box -> ops = & jp2_boxinfo_unk . ops ; //<S2SV> jas_eprintf ( "cannot<S2SV_blank>copy<S2SV_blank>box<S2SV_blank>data\\n" ) ; //<S2SV> goto error ; //<S2SV> } //<S2SV> jas_stream_rewind ( tmpstream ) ; //<S2SV> if ( box -> ops -> getdata ) { //<S2SV> if ( ( * box -> ops -> getdata ) ( box , tmpstream ) ) { //<S2SV> jas_eprintf ( "cannot<S2SV_blank>parse<S2SV_blank>box<S2SV_blank>data\\n" ) ; //<S2SV> goto error ; //<S2SV> } //<S2SV> } //<S2SV> jas_stream_close ( tmpstream ) ; //<S2SV> } //<S2SV> if ( jas_getdbglevel ( ) >= 1 ) { //<S2SV> jp2_box_dump ( box , stderr ) ; //<S2SV> } //<S2SV> return box ; //<S2SV> error : //<S2SV> if ( box ) { //<S2SV> jp2_box_destroy ( box ) ; //<S2SV> } //<S2SV> if ( tmpstream ) { //<S2SV> jas_stream_close ( tmpstream ) ; //<S2SV> } //<S2SV> return 0 ; //<S2SV> } //<S2SV> 