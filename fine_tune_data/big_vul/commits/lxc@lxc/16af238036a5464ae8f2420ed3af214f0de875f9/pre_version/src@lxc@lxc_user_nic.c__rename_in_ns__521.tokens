static int rename_in_ns ( int pid , char * oldname , char * * newnamep ) //<S2SV> { //<S2SV> int fd = - 1 , ofd = - 1 , ret , ifindex = - 1 ; //<S2SV> bool grab_newname = false ; //<S2SV> ofd = lxc_preserve_ns ( getpid ( ) , "net" ) ; //<S2SV> if ( ofd < 0 ) { //<S2SV> fprintf ( stderr , "Failed<S2SV_blank>opening<S2SV_blank>network<S2SV_blank>namespace<S2SV_blank>path<S2SV_blank>for<S2SV_blank>\'%d\'." , getpid ( ) ) ; //<S2SV> return - 1 ; //<S2SV> } //<S2SV> fd = lxc_preserve_ns ( pid , "net" ) ; //<S2SV> if ( fd < 0 ) { //<S2SV> fprintf ( stderr , "Failed<S2SV_blank>opening<S2SV_blank>network<S2SV_blank>namespace<S2SV_blank>path<S2SV_blank>for<S2SV_blank>\'%d\'." , pid ) ; //<S2SV> return - 1 ; //<S2SV> } //<S2SV> if ( setns ( fd , 0 ) < 0 ) { //<S2SV> fprintf ( stderr , "setns<S2SV_blank>to<S2SV_blank>container<S2SV_blank>network<S2SV_blank>namespace\\n" ) ; //<S2SV> goto out_err ; //<S2SV> } //<S2SV> close ( fd ) ; fd = - 1 ; //<S2SV> if ( ! * newnamep ) { //<S2SV> grab_newname = true ; //<S2SV> * newnamep = VETH_DEF_NAME ; //<S2SV> if ( ! ( ifindex = if_nametoindex ( oldname ) ) ) { //<S2SV> fprintf ( stderr , "failed<S2SV_blank>to<S2SV_blank>get<S2SV_blank>netdev<S2SV_blank>index\\n" ) ; //<S2SV> goto out_err ; //<S2SV> } //<S2SV> } //<S2SV> if ( ( ret = lxc_netdev_rename_by_name ( oldname , * newnamep ) ) < 0 ) { //<S2SV> fprintf ( stderr , "Error<S2SV_blank>%d<S2SV_blank>renaming<S2SV_blank>netdev<S2SV_blank>%s<S2SV_blank>to<S2SV_blank>%s<S2SV_blank>in<S2SV_blank>container\\n" , ret , oldname , * newnamep ) ; //<S2SV> goto out_err ; //<S2SV> } //<S2SV> if ( grab_newname ) { //<S2SV> char ifname [ IFNAMSIZ ] , * namep = ifname ; //<S2SV> if ( ! if_indextoname ( ifindex , namep ) ) { //<S2SV> fprintf ( stderr , "Failed<S2SV_blank>to<S2SV_blank>get<S2SV_blank>new<S2SV_blank>netdev<S2SV_blank>name\\n" ) ; //<S2SV> goto out_err ; //<S2SV> } //<S2SV> * newnamep = strdup ( namep ) ; //<S2SV> if ( ! * newnamep ) //<S2SV> goto out_err ; //<S2SV> } //<S2SV> if ( setns ( ofd , 0 ) < 0 ) { //<S2SV> fprintf ( stderr , "Error<S2SV_blank>returning<S2SV_blank>to<S2SV_blank>original<S2SV_blank>netns\\n" ) ; //<S2SV> close ( ofd ) ; //<S2SV> return - 1 ; //<S2SV> } //<S2SV> close ( ofd ) ; //<S2SV> return 0 ; //<S2SV> out_err : //<S2SV> if ( ofd >= 0 ) //<S2SV> close ( ofd ) ; //<S2SV> if ( setns ( ofd , 0 ) < 0 ) //<S2SV> fprintf ( stderr , "Error<S2SV_blank>returning<S2SV_blank>to<S2SV_blank>original<S2SV_blank>network<S2SV_blank>namespace\\n" ) ; //<S2SV> if ( fd >= 0 ) //<S2SV> close ( fd ) ; //<S2SV> return - 1 ; //<S2SV> } //<S2SV> 