int lsm_set_label_at ( int procfd , int on_exec , char * lsm_label ) { //<S2SV> int labelfd = - 1 ; //<S2SV> int ret = 0 ; //<S2SV> const char * name ; //<S2SV> char * command = NULL ; //<S2SV> name = lsm_name ( ) ; //<S2SV> if ( strcmp ( name , "nop" ) == 0 ) //<S2SV> goto out ; //<S2SV> if ( strcmp ( name , "none" ) == 0 ) //<S2SV> goto out ; //<S2SV> if ( strcmp ( name , "AppArmor" ) == 0 ) //<S2SV> on_exec = 0 ; //<S2SV> if ( on_exec ) { //<S2SV> labelfd = openat ( procfd , "self/attr/exec" , O_RDWR ) ; //<S2SV> } //<S2SV> else { //<S2SV> labelfd = openat ( procfd , "self/attr/current" , O_RDWR ) ; //<S2SV> } //<S2SV> if ( labelfd < 0 ) { //<S2SV> SYSERROR ( "Unable<S2SV_blank>to<S2SV_blank>open<S2SV_blank>LSM<S2SV_blank>label" ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> if ( strcmp ( name , "AppArmor" ) == 0 ) { //<S2SV> int size ; //<S2SV> command = malloc ( strlen ( lsm_label ) + strlen ( "changeprofile<S2SV_blank>" ) + 1 ) ; //<S2SV> if ( ! command ) { //<S2SV> SYSERROR ( "Failed<S2SV_blank>to<S2SV_blank>write<S2SV_blank>apparmor<S2SV_blank>profile" ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> size = sprintf ( command , "changeprofile<S2SV_blank>%s" , lsm_label ) ; //<S2SV> if ( size < 0 ) { //<S2SV> SYSERROR ( "Failed<S2SV_blank>to<S2SV_blank>write<S2SV_blank>apparmor<S2SV_blank>profile" ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> if ( write ( labelfd , command , size + 1 ) < 0 ) { //<S2SV> SYSERROR ( "Unable<S2SV_blank>to<S2SV_blank>set<S2SV_blank>LSM<S2SV_blank>label" ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> } //<S2SV> else if ( strcmp ( name , "SELinux" ) == 0 ) { //<S2SV> if ( write ( labelfd , lsm_label , strlen ( lsm_label ) + 1 ) < 0 ) { //<S2SV> SYSERROR ( "Unable<S2SV_blank>to<S2SV_blank>set<S2SV_blank>LSM<S2SV_blank>label" ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> } //<S2SV> else { //<S2SV> ERROR ( "Unable<S2SV_blank>to<S2SV_blank>restore<S2SV_blank>label<S2SV_blank>for<S2SV_blank>unknown<S2SV_blank>LSM:<S2SV_blank>%s" , name ) ; //<S2SV> ret = - 1 ; //<S2SV> goto out ; //<S2SV> } //<S2SV> out : //<S2SV> free ( command ) ; //<S2SV> if ( labelfd != - 1 ) //<S2SV> close ( labelfd ) ; //<S2SV> return ret ; //<S2SV> } //<S2SV> 