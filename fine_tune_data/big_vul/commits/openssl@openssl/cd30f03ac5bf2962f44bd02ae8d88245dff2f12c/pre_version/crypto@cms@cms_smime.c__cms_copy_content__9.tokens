static int cms_copy_content ( BIO * out , BIO * in , unsigned int flags ) //<S2SV> { //<S2SV> unsigned char buf [ 4096 ] ; //<S2SV> int r = 0 , i ; //<S2SV> BIO * tmpout = NULL ; //<S2SV> if ( out == NULL ) //<S2SV> tmpout = BIO_new ( BIO_s_null ( ) ) ; //<S2SV> else if ( flags & CMS_TEXT ) //<S2SV> { //<S2SV> tmpout = BIO_new ( BIO_s_mem ( ) ) ; //<S2SV> BIO_set_mem_eof_return ( tmpout , 0 ) ; //<S2SV> } //<S2SV> else //<S2SV> tmpout = out ; //<S2SV> if ( ! tmpout ) //<S2SV> { //<S2SV> CMSerr ( CMS_F_CMS_COPY_CONTENT , ERR_R_MALLOC_FAILURE ) ; //<S2SV> goto err ; //<S2SV> } //<S2SV> for ( ; ; ) //<S2SV> { //<S2SV> i = BIO_read ( in , buf , sizeof ( buf ) ) ; //<S2SV> if ( i <= 0 ) //<S2SV> { //<S2SV> if ( BIO_method_type ( in ) == BIO_TYPE_CIPHER ) //<S2SV> { //<S2SV> if ( ! BIO_get_cipher_status ( in ) ) //<S2SV> goto err ; //<S2SV> } //<S2SV> if ( i < 0 ) //<S2SV> goto err ; //<S2SV> break ; //<S2SV> } //<S2SV> if ( tmpout && ( BIO_write ( tmpout , buf , i ) != i ) ) //<S2SV> goto err ; //<S2SV> } //<S2SV> if ( flags & CMS_TEXT ) //<S2SV> { //<S2SV> if ( ! SMIME_text ( tmpout , out ) ) //<S2SV> { //<S2SV> CMSerr ( CMS_F_CMS_COPY_CONTENT , CMS_R_SMIME_TEXT_ERROR ) ; //<S2SV> goto err ; //<S2SV> } //<S2SV> } //<S2SV> r = 1 ; //<S2SV> err : //<S2SV> if ( tmpout && ( tmpout != out ) ) //<S2SV> BIO_free ( tmpout ) ; //<S2SV> return r ; //<S2SV> } //<S2SV> 