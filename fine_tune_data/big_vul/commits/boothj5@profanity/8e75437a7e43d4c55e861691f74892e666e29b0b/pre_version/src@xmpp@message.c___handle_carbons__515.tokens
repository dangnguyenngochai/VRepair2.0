static gboolean //<S2SV> _handle_carbons ( xmpp_stanza_t * const stanza ) //<S2SV> { //<S2SV> xmpp_stanza_t * carbons = xmpp_stanza_get_child_by_ns ( stanza , STANZA_NS_CARBONS ) ; //<S2SV> if ( ! carbons ) { //<S2SV> return FALSE ; //<S2SV> } //<S2SV> const char * name = xmpp_stanza_get_name ( carbons ) ; //<S2SV> if ( ! name ) { //<S2SV> log_error ( "Unable<S2SV_blank>to<S2SV_blank>retrieve<S2SV_blank>stanza<S2SV_blank>name<S2SV_blank>for<S2SV_blank>Carbon" ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> if ( g_strcmp0 ( name , "private" ) == 0 ) { //<S2SV> log_info ( "Carbon<S2SV_blank>received<S2SV_blank>with<S2SV_blank>private<S2SV_blank>element." ) ; //<S2SV> return FALSE ; //<S2SV> } //<S2SV> if ( ( g_strcmp0 ( name , "received" ) != 0 ) && ( g_strcmp0 ( name , "sent" ) != 0 ) ) { //<S2SV> log_warning ( "Carbon<S2SV_blank>received<S2SV_blank>with<S2SV_blank>unrecognised<S2SV_blank>stanza<S2SV_blank>name:<S2SV_blank>%s" , name ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> xmpp_stanza_t * forwarded = xmpp_stanza_get_child_by_ns ( carbons , STANZA_NS_FORWARD ) ; //<S2SV> if ( ! forwarded ) { //<S2SV> log_warning ( "Carbon<S2SV_blank>received<S2SV_blank>with<S2SV_blank>no<S2SV_blank>forwarded<S2SV_blank>element" ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> xmpp_stanza_t * message = xmpp_stanza_get_child_by_name ( forwarded , STANZA_NAME_MESSAGE ) ; //<S2SV> if ( ! message ) { //<S2SV> log_warning ( "Carbon<S2SV_blank>received<S2SV_blank>with<S2SV_blank>no<S2SV_blank>message<S2SV_blank>element" ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> char * message_txt = xmpp_message_get_body ( message ) ; //<S2SV> if ( ! message_txt ) { //<S2SV> log_warning ( "Carbon<S2SV_blank>received<S2SV_blank>with<S2SV_blank>no<S2SV_blank>message." ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> const gchar * to = xmpp_stanza_get_to ( message ) ; //<S2SV> const gchar * from = xmpp_stanza_get_from ( message ) ; //<S2SV> if ( ! to ) to = from ; //<S2SV> Jid * jid_from = jid_create ( from ) ; //<S2SV> Jid * jid_to = jid_create ( to ) ; //<S2SV> Jid * my_jid = jid_create ( connection_get_fulljid ( ) ) ; //<S2SV> char * enc_message = NULL ; //<S2SV> xmpp_stanza_t * x = xmpp_stanza_get_child_by_ns ( message , STANZA_NS_ENCRYPTED ) ; //<S2SV> if ( x ) { //<S2SV> enc_message = xmpp_stanza_get_text ( x ) ; //<S2SV> } //<S2SV> if ( g_strcmp0 ( my_jid -> barejid , jid_to -> barejid ) == 0 ) { //<S2SV> sv_ev_incoming_carbon ( jid_from -> barejid , jid_from -> resourcepart , message_txt , enc_message ) ; //<S2SV> } else { //<S2SV> sv_ev_outgoing_carbon ( jid_to -> barejid , message_txt , enc_message ) ; //<S2SV> } //<S2SV> xmpp_ctx_t * ctx = connection_get_ctx ( ) ; //<S2SV> xmpp_free ( ctx , message_txt ) ; //<S2SV> xmpp_free ( ctx , enc_message ) ; //<S2SV> jid_destroy ( jid_from ) ; //<S2SV> jid_destroy ( jid_to ) ; //<S2SV> jid_destroy ( my_jid ) ; //<S2SV> return TRUE ; //<S2SV> } //<S2SV> 