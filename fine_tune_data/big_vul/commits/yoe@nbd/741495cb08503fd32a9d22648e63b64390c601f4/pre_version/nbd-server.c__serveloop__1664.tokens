void serveloop ( GArray * servers ) { //<S2SV> struct sockaddr_storage addrin ; //<S2SV> socklen_t addrinlen = sizeof ( addrin ) ; //<S2SV> int i ; //<S2SV> int max ; //<S2SV> fd_set mset ; //<S2SV> fd_set rset ; //<S2SV> max = 0 ; //<S2SV> FD_ZERO ( & mset ) ; //<S2SV> for ( i = 0 ; i < servers -> len ; i ++ ) { //<S2SV> int sock ; //<S2SV> if ( ( sock = ( g_array_index ( servers , SERVER , i ) ) . socket ) >= 0 ) { //<S2SV> FD_SET ( sock , & mset ) ; //<S2SV> max = sock > max ? sock : max ; //<S2SV> } //<S2SV> } //<S2SV> for ( i = 0 ; i < modernsocks -> len ; i ++ ) { //<S2SV> int sock = g_array_index ( modernsocks , int , i ) ; //<S2SV> FD_SET ( sock , & mset ) ; //<S2SV> max = sock > max ? sock : max ; //<S2SV> } //<S2SV> for ( ; ; ) { //<S2SV> if ( is_sighup_caught ) { //<S2SV> int n ; //<S2SV> GError * gerror = NULL ; //<S2SV> msg ( LOG_INFO , "reconfiguration<S2SV_blank>request<S2SV_blank>received" ) ; //<S2SV> is_sighup_caught = 0 ; //<S2SV> n = append_new_servers ( servers , & gerror ) ; //<S2SV> if ( n == - 1 ) //<S2SV> msg ( LOG_ERR , "failed<S2SV_blank>to<S2SV_blank>append<S2SV_blank>new<S2SV_blank>servers:<S2SV_blank>%s" , //<S2SV> gerror -> message ) ; //<S2SV> for ( i = servers -> len - n ; i < servers -> len ; ++ i ) { //<S2SV> const SERVER server = g_array_index ( servers , //<S2SV> SERVER , i ) ; //<S2SV> if ( server . socket >= 0 ) { //<S2SV> FD_SET ( server . socket , & mset ) ; //<S2SV> max = server . socket > max ? server . socket : max ; //<S2SV> } //<S2SV> msg ( LOG_INFO , "reconfigured<S2SV_blank>new<S2SV_blank>server:<S2SV_blank>%s" , //<S2SV> server . servename ) ; //<S2SV> } //<S2SV> } //<S2SV> memcpy ( & rset , & mset , sizeof ( fd_set ) ) ; //<S2SV> if ( select ( max + 1 , & rset , NULL , NULL , NULL ) > 0 ) { //<S2SV> int net ; //<S2SV> DEBUG ( "accept,<S2SV_blank>" ) ; //<S2SV> for ( i = 0 ; i < modernsocks -> len ; i ++ ) { //<S2SV> int sock = g_array_index ( modernsocks , int , i ) ; //<S2SV> if ( ! FD_ISSET ( sock , & rset ) ) { //<S2SV> continue ; //<S2SV> } //<S2SV> CLIENT * client ; //<S2SV> if ( ( net = accept ( sock , ( struct sockaddr * ) & addrin , & addrinlen ) ) < 0 ) { //<S2SV> err_nonfatal ( "accept:<S2SV_blank>%m" ) ; //<S2SV> continue ; //<S2SV> } //<S2SV> client = negotiate ( net , NULL , servers , NEG_INIT | NEG_MODERN ) ; //<S2SV> if ( ! client ) { //<S2SV> close ( net ) ; //<S2SV> continue ; //<S2SV> } //<S2SV> handle_connection ( servers , net , client -> server , client ) ; //<S2SV> } //<S2SV> for ( i = 0 ; i < servers -> len ; i ++ ) { //<S2SV> SERVER * serve ; //<S2SV> serve = & ( g_array_index ( servers , SERVER , i ) ) ; //<S2SV> if ( serve -> socket < 0 ) { //<S2SV> continue ; //<S2SV> } //<S2SV> if ( FD_ISSET ( serve -> socket , & rset ) ) { //<S2SV> if ( ( net = accept ( serve -> socket , ( struct sockaddr * ) & addrin , & addrinlen ) ) < 0 ) { //<S2SV> err_nonfatal ( "accept:<S2SV_blank>%m" ) ; //<S2SV> continue ; //<S2SV> } //<S2SV> handle_connection ( servers , net , serve , NULL ) ; //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> } //<S2SV> 