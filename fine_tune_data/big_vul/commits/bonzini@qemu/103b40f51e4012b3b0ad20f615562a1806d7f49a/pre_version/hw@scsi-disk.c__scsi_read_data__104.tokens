static void scsi_read_data ( SCSIRequest * req ) //<S2SV> { //<S2SV> SCSIDiskReq * r = DO_UPCAST ( SCSIDiskReq , req , req ) ; //<S2SV> SCSIDiskState * s = DO_UPCAST ( SCSIDiskState , qdev , r -> req . dev ) ; //<S2SV> uint32_t n ; //<S2SV> if ( r -> sector_count == ( uint32_t ) - 1 ) { //<S2SV> DPRINTF ( "Read<S2SV_blank>buf_len=%zd\\n" , r -> iov . iov_len ) ; //<S2SV> r -> sector_count = 0 ; //<S2SV> scsi_req_data ( & r -> req , r -> iov . iov_len ) ; //<S2SV> return ; //<S2SV> } //<S2SV> DPRINTF ( "Read<S2SV_blank>sector_count=%d\\n" , r -> sector_count ) ; //<S2SV> if ( r -> sector_count == 0 ) { //<S2SV> scsi_req_complete ( & r -> req , GOOD ) ; //<S2SV> return ; //<S2SV> } //<S2SV> assert ( r -> req . aiocb == NULL ) ; //<S2SV> if ( r -> req . cmd . mode == SCSI_XFER_TO_DEV ) { //<S2SV> DPRINTF ( "Data<S2SV_blank>transfer<S2SV_blank>direction<S2SV_blank>invalid\\n" ) ; //<S2SV> scsi_read_complete ( r , - EINVAL ) ; //<S2SV> return ; //<S2SV> } //<S2SV> n = r -> sector_count ; //<S2SV> if ( n > SCSI_DMA_BUF_SIZE / 512 ) //<S2SV> n = SCSI_DMA_BUF_SIZE / 512 ; //<S2SV> if ( s -> tray_open ) { //<S2SV> scsi_read_complete ( r , - ENOMEDIUM ) ; //<S2SV> } //<S2SV> r -> iov . iov_len = n * 512 ; //<S2SV> qemu_iovec_init_external ( & r -> qiov , & r -> iov , 1 ) ; //<S2SV> bdrv_acct_start ( s -> bs , & r -> acct , n * BDRV_SECTOR_SIZE , BDRV_ACCT_READ ) ; //<S2SV> r -> req . aiocb = bdrv_aio_readv ( s -> bs , r -> sector , & r -> qiov , n , //<S2SV> scsi_read_complete , r ) ; //<S2SV> if ( r -> req . aiocb == NULL ) { //<S2SV> scsi_read_complete ( r , - EIO ) ; //<S2SV> } //<S2SV> } //<S2SV> 